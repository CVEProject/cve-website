<template>
  <div id="cve-secondary-page-main-container">
    <div class="columns is-centered">
      <div class="column is-8-desktop cve-main-column-content-width">
        <main id="cve-main-page-content" role="main">
          <div class="content">
          <div class="loader-wrapper is-active" v-if="this.$store.state.isSearching">
            <p class="is-size-5">Please wait. Loading...</p>
            <p class="loader is-loading mb-4 ml-1"></p>
          </div>
          <div v-else>
            <div v-if="this.$store.state.serverError" style="text-align: center;">
              <h1 class="title is-4">Service is currently unavailable.</h1>
              <p style="text-align: center;">Please
                <span class="icon-text">
                  <a href="https://cveform.mitre.org/" target="_blank">report the issue
                    <span class="icon is-size-7 cve-icon-xxs">
                      <p id="extenalLink1" class="is-hidden">external site</p>
                      <font-awesome-icon icon="external-link-alt" aria-labelledby="extenalLink1" aria-hidden="false" focusable="false"/>
                    </span>
                  </a>
                </span>
                and try again later. Sorry for the inconvenience.
              </p>
            </div>
            <p v-if="this.$store.state.showHelpText" style="text-align: center;">Please use the search box above to find a CVE record by ID.</p>
            <div v-if="!this.$store.state.isSearching && !this.$store.state.showHelpText && !this.$store.state.serverError">
              <div v-if="this.$store.state.error" style="text-align: center !important">
                <h1 class="title is-3 is-4 mb-2">{{this.$store.state.cveId}} not found.</h1>
                <span class="icon-text">
                  <a href="https://cve.mitre.org/cve/search_cve_list.html" target="_blank">
                  Find CVE Record by Keyword
                  <span class="icon cve-icon-xxs" style="margin-left: 0px;">
                    <p id="CVERecordsKeywordSearch" class="is-hidden">external site</p>
                    <font-awesome-icon icon="external-link-alt" aria-labelledby="CVERecordsKeywordSearch">
                    </font-awesome-icon>
                  </span>
                  </a>
                </span>
              </div>
              <div v-else>
                <h1 class="title is-3 is-3">{{this.$store.state.recordData.ID}} Detail</h1>
                <p class="cve-help-text">
                  The CVE Record information displayed on this page may not be displaying the full range of available information due to differences
                  in how the data may have been entered. If you feel that the information being displayed is not meeting your expectations, please let
                  us know by using this <a href="https://forms.office.com/Pages/ResponsePage.aspx?id=SNwgxlAdUkmLOd9NVNdNgpACCE8tvfVOvUZBFBD8MXhUMTZHN
                  Vo0VElUTzBQWVFBRUJDQUM3TjRKWiQlQCN0PWcu" target="_blank">feedback form</a>.
                </p>
                <section class="cve-accordian mb-1">
                  <div class="message">
                    <div class="message-header cve-base-light-gray-borders-bg">
                      <p style="margin-top: auto !important; margin-bottom: auto !important">
                        {{this.$store.state.showJsonRecord ? 'Hide' : 'View'}} full JSON 4.0 record
                      </p>
                      <button class="button" @click="toggleRecord"
                        :aria-expanded="!this.$store.state.showJsonRecord ? 'true' : 'false'" aria-controls="cve-id">
                        <span class="icon is-small">
                          <p id="cve-id-alttext" class="is-hidden">
                            {{this.$store.state.showJsonRecord ? 'collapse' : 'expand'}}
                          </p>
                          <font-awesome-icon :icon="this.$store.state.showJsonRecord ? 'minus' : 'plus'"
                          aria-hidden="false" focusable="true" aria-labelledby="cve-id-alttext"/>
                        </span>
                      </button>
                    </div>
                    <div class="message-body pb-0" :class="[{'is-hidden': !this.$store.state.showJsonRecord}]" id="cve-json">
                      <pre>{{JSON.stringify(this.$store.state.JsonData, null, 2)}}</pre>
                    </div>
                  </div>
                </section>
                <div class="cve-scrollx-table-container">
                  <table class="table is-striped is-hoverable cve-border-dark-blue">
                    <caption class="is-hidden">{{this.$store.state.recordData.ID}} Detail</caption>
                    <tbody>
                      <tr v-if="this.$store.state.recordData.description_data !== undefined &&
                        this.$store.state.recordData.description_data.length > 0">
                        <th scope="row">Description</th>
                        <td>
                          <div v-for="descriptionArray in this.$store.state.recordData.description_data" :key="descriptionArray.index">
                            <span v-for="description in descriptionArray" :key="description.index">
                              <p v-if="description !== ''">{{description}}</p>
                            </span>
                          </div>
                        </td>
                      </tr>
                      <tr v-if="this.$store.state.recordData.STATE !== undefined">
                        <th scope="row">State</th>
                        <td><span>{{this.$store.state.recordData.STATE}}</span></td>
                      </tr>
                      <tr v-if="this.$store.state.recordData.UPDATED !== undefined">
                        <th scope="row">Updated</th>
                        <td><time :datetime="this.$store.state.recordData.UPDATED">{{this.$store.state.recordData.UPDATED}}</time></td>
                      </tr>
                      <tr v-if="this.$store.state.recordData.problemtype_data && this.$store.state.recordData.problemtype_data.length > 0
                        && this.$store.state.recordData.problemtype_data[0] !== ''">
                        <th scope="row">Problem Types</th>
                        <td>
                          <ul v-for="problemArray in this.$store.state.recordData.problemtype_data" :key="problemArray.index">
                            <span v-for="problem in problemArray" :key="problem.index">
                              <li v-if="problem !== ''"><span>{{problem}}</span></li>
                            </span>
                          </ul>
                        </td>
                      </tr>
                      <tr v-if=" this.$store.state.recordData.affects !== undefined && this.$store.state.recordData.affects.vendors !== undefined &&
                        this.$store.state.recordData.affects.vendors.length > 0 &&
                        (this.$store.state.recordData.affects.vendors[0].vendor_name !== 'n/a'
                          || (this.$store.state.recordData.affects.vendors[0].vendor_name == 'n/a' &&
                            this.$store.state.recordData.affects.vendors[0].products[0].product_name !== 'n/a'))">
                        <th scope="row">Vendors, Products & Versions</th>
                        <td>
                          <ul v-for="vendorProductVersion in this.$store.state.recordData.affects.vendors" :key="vendorProductVersion.index"
                            class="ml-0">
                            <li class="cve-list-no-bullet">
                              <span class="has-text-weight-bold">Vendor: </span>
                              <span v-if="vendorProductVersion.vendor_name == 'n/a'" class="is-italic">Not Specified</span>
                              <span v-else>{{vendorProductVersion.vendor_name}}</span>
                            </li>
                            <ul v-for="ProductVersion in vendorProductVersion.products" :key="ProductVersion.index" class="mb-2">
                              <li v-if="ProductVersion !== undefined" class="cve-list-no-bullet">
                                <span class="has-text-weight-bold">Product: </span><span>{{ProductVersion.product_name}}</span>
                              </li>
                              <li v-if="ProductVersion.vendor_version.length > 0" class="cve-list-no-bullet">
                                <ul>
                                  <span class="has-text-weight-bold">Versions Affected: </span>
                                  <li v-for="valueAffected in ProductVersion.vendor_version" :key="valueAffected.version_value.index"
                                    class="ml-5">
                                    <span v-if="valueAffected.version_affected != ''">
                                      {{valueAffected.version_affected}}{{valueAffected.version_value}}<span v-if="valueAffected.definition !== ''">:
                                        {{valueAffected.definition}}</span>
                                    </span>
                                    <span v-else>
                                      {{valueAffected.version_value}}
                                    </span>
                                  </li>
                                </ul>
                              </li>
                            </ul>
                          </ul>
                        </td>
                      </tr>
                      <tr v-if="this.$store.state.recordData.reference_data !== undefined">
                        <th scope="row">References</th>
                        <td>
                          <ul v-for="reference in this.$store.state.recordData.reference_data" :key="reference.index">
                            <li v-if="reference.url !== undefined" class="cve-task-tile-list-item">
                              <a :href="reference.url" class="cve-word-wrap" target="_blank">
                                {{reference.url}}
                              </a>
                            </li>
                          </ul>
                          <span>
                            View additional information about
                            <a :href="`https://nvd.nist.gov/view/vuln/detail?vulnId=${this.$store.state.recordData.ID}`" target="_blank">
                              {{this.$store.state.recordData.ID}}
                              <span class="icon cve-icon-xxs">
                                <p id="nvd" class="is-hidden">external site</p>
                                <font-awesome-icon icon="external-link-alt" aria-labelledby="nvd">
                                </font-awesome-icon>
                              </span>
                            </a>
                            on NVD.
                          </span>
                          <p class="cve-help-text">(Note: The NVD is not operated by the CVE Program)</p>
                        </td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
          </div>
        </main>
      </div>
    </div>
  </div>
</template>

<script>
export default {
  name: 'CVERecord',
  methods: {
    toggleRecord() {
      this.$store.commit('updateState', { showJsonRecord: !this.$store.state.showJsonRecord });
    },
  },
};

</script>

<style scoped lang="scss">
@import '@/assets/style/globals.scss';
pre {
  outline: 1px solid $theme-color-primary-darker; padding: 5px; margin: 5px;
}

th {
  border-bottom: 1px white solid !important;
}

.cve-word-wrap {
  overflow-wrap: break-word;
  word-wrap: break-word;
  -ms-word-break: break-all;
  word-break: break-all;
  word-break: break-word;
  -ms-hyphens: auto;
  -moz-hyphens: auto;
  -webkit-hyphens: auto;
  hyphens: auto;
}

tr:first-child th {
  border-top-color: $theme-color-primary-darker !important;
}

tr:last-child th {
  border-bottom-color: $theme-color-primary-darker !important;
}

.loader-wrapper {
  background: #fff;
  opacity: 0;
  z-index: -1;
  transition: opacity .3s;
  display: flex;
  justify-content: center;
  align-items: center;

  &.is-active {
      opacity: 1;
      z-index: 1;
  }
}

pre {
  white-space: pre-wrap !important;
}
</style>
