<template>
  <div id="cve-secondary-page-main-container">
    <div class="columns is-centered">
      <div class="column is-8-desktop cve-main-column-content-width">
        <main id="cve-main-page-content" role="main">
          <div class="content">
            <div v-if="useCveListSearchStore.showHelpText">
              <p class="has-text-centered">
                Please use the help text below the search box above to fix your keyword(s).
              </p></div>
            <div v-else>
              <div v-if="useCveListSearchStore.cveRecordIsLoading || useCveListSearchStore.searchResultIsLoading"
                class="cve-loading-message has-text-centered"
              >
                <span class="icon-text">
                  <span class="icon">
                    <span class="loader is-loading" />
                  </span>
                  <span>Please wait. Loading...</span>
                </span>
              </div>
              <div v-else>
                <div v-if="useCveListSearchStore.isSearchServerError" class="has-text-centered">
                  <h1 class="title is-4">Service is currently unavailable.</h1>
                  <p style="text-align: center;">Please
                    <span class="icon-text">
                      <a href="https://cveform.mitre.org/" target="_blank">report the issue
                        <span class="icon is-size-7 cve-icon-xxs">
                          <p id="extenalLink1" class="is-hidden">external site</p>
                          <font-awesome-icon icon="external-link-alt" aria-labelledby="extenalLink1" aria-hidden="false" focusable="false"/>
                        </span>
                      </a>
                    </span>
                    and try again later.<br/>Or, use
                    <a href="https://cve.mitre.org/cve/search_cve_list.html" target="_blank">Search CVE List on cve.mitre.org
                      <span class="icon is-size-7 cve-icon-xxs">
                        <p id="extenalLink1" class="is-hidden">external site</p>
                        <font-awesome-icon icon="external-link-alt" aria-labelledby="extenalLink1" aria-hidden="false" focusable="false"/>
                      </span>
                    </a>
                    to search CVE Records. Sorry for the inconvenience.
                  </p>
                </div>
                <div v-else>
                  <div v-if="useCveListSearchStore.totalSearchResultCount <= 0" class="has-text-centered">
                    <p>No search results.</p>
                  </div>
                  <div v-else>
                    <div>
                      <p>
                        <span>Showing </span>
                        <span class="has-text-weight-bold">
                          {{ (pagination.currentPage * showCount) + 1 }} - {{ (pagination.currentPage * showCount) + showCount }}
                        </span>
                        <span> of </span>
                        <span class="has-text-weight-bold">
                          {{ useCveListSearchStore.totalSearchResultCount.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',') }}
                        </span>
                        <span> results for </span>
                        <span class="has-text-weight-bold">{{ useCveListSearchStore.query }}</span>
                      </p>
                    </div>
                    <div class="field is-grouped is-grouped-right">
                      <label class="label">Show:</label>
                      <div class="control">
                        <div class="select">
                          <select v-model="showCount" aria-label="Select how many search results to show">
                            <option>25</option>
                            <option>50</option>
                            <option>100</option>
                            <option>150</option>
                            <option>200</option>
                          </select>
                        </div>
                      </div>
                      <label class="label">Sort by:</label>
                      <div class="control">
                        <div class="select">
                          <select name="partner" v-model="sortBy" aria-label="Select a sort by direction">
                            <option v-bind:value='{field: "cveId", direction: "asc"}'>CVE ID (newest to oldest)</option>
                            <option v-bind:value='{field: "cveId", direction: "desc"}'>CVE ID (oldest to newest)</option>
                            <option v-bind:value='{field: "relevancy", direction: "asc"}'>Relevancy (most to least)</option>
                            <option v-bind:value='{field: "relevancy", direction: "desc"}'>Relevancy (least to most)</option>
                          </select>
                        </div>
                      </div>
                    </div>
                    <nav class="pagination is-centered" role="navigation" aria-label="pagination">
                      <button @click=getPreviousPage
                        :disabled="pagination.currentPage <= 0 ? true : false"
                        :aria-disabled="pagination.currentPage <= 0 ? true : false"
                        class="pagination-previous"
                      >
                        Previous
                      </button>
                      <button @click=getNextPage
                        :disabled="pagination.currentPage <= pagination.endPage ? false : true"
                        :aria-disabled="pagination.currentPage <= pagination.endPage ? false : true"
                        class="pagination-next"
                      >
                        Next page
                      </button>
                      <ul class="pagination-list">
                        <li><a class="pagination-link is-current" aria-label="Goto page 1">1</a></li>
                        <li><span class="pagination-ellipsis">&hellip;</span></li>
                        <li><a class="pagination-link" aria-label="Goto page 45">45</a></li>
                        <li><a class="pagination-link" aria-label="Page 46" aria-current="page">46</a></li>
                        <li><a class="pagination-link" aria-label="Goto page 47">47</a></li>
                        <li><span class="pagination-ellipsis">&hellip;</span></li>
                        <li><a class="pagination-link" aria-label="Goto page 86">86</a></li>
                      </ul>
                    </nav>
                    <div v-if="Object.keys(useCveListSearchStore.recordData).length > 0 || useCveListSearchStore.totalSearchResultCount > 0"
                      class="table-container"
                    >
                      <table class="table is-striped is-hoverable cve-border-dark-blue is-fullwidth mb-1">
                        <thead>
                          <tr>
                            <th scope="col" class="is-hidden-desktop" >CVE ID</th>
                            <th scope="col" class="is-hidden-touch" style="width: 20%">CVE ID</th>
                            <th scope="col" class="is-hidden-desktop" >CNA</th>
                            <th scope="col" class="is-hidden-touch" style="width: 20%">CNA</th>
                            <th scope="col">Description</th>
                            <th scope="col" class="is-hidden-desktop" >Relevancy</th>
                            <th scope="col" class="is-hidden-touch" style="width: 20%">Relevancy</th>
                          </tr>
                        </thead>
                        <tbody>
                          <tr class="cve-search-result" v-if="Object.keys(useCveListSearchStore.recordData).length > 0">
                            <td data-label="CVE ID" class="is-hidden-touch">{{ useCveListSearchStore.recordData.cveId }}</td>
                            <td data-label="CNA" class="is-hidden-touch">{{ useCveListSearchStore.recordData.cna }}</td>
                            <td data-label="Description">
                              <p v-for="description in useCveListSearchStore.recordData.descriptions" :key="description.key">{{ description }}</p>
                            </td>
                            <td data-label="Relavancy Score" class="is-hidden-touch">{{ useCveListSearchStore.recordData.relevancyScore }}</td>
                          </tr>
                          <tr v-for="result in useCveListSearchStore.searchResults" :key="result.key">
                            <td data-label="CVE ID" style="width: 20%">{{ result.cveId }}</td>
                            <td data-label="CNA" style="width: 20%">{{ result.cna }}</td>
                            <td data-label="Description">
                              <p v-for="description in result.descriptions" :key="description.key">{{ description }}</p>
                            </td>
                            <td data-label="Relavancy Score" class="is-hidden-touch">{{ result.relevancyScore }}</td>
                          </tr>
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </main>
      </div>
    </div>
  </div>
</template>

<script>
  import { useCveListSearchStore } from '@/stores/cveListSearch';

  export default {
    name: 'SearchResults',
    data() {
      return {
        isMessageExpanded: false,
        useCveListSearchStore: useCveListSearchStore(),
        showCount: 25,
        sortBy: {
          field: 'cveId',
          direction: 'asc',
        },
        pagination: {
          startPage: 1,
          currentPage: 0,
          endPage: 1,
          pageSize: 10,
          pageSizeMin: 10,
          pageSizeMax: 1000,
          totalPages: 0,
          startIndex: 0,
          endIndex: 0,
          maxPages: 17,
          pages: [],
          currentCNAstoDisplay: [],
        },
      };
    },
    beforeMount(){
      this.calcTotalPages();
      console.log(this.pagination.endPage)
    },
    watch: {
      showCount() {
        this.calcTotalPages();
        this.getPage();
      },
      sortBy() {}
    },
    methods: {
      calcTotalPages() {
        this.pagination.endPage = Math.floor(this.useCveListSearchStore.totalSearchResultCount / this.showCount);
      },
      getNextPage() {
        this.pagination.currentPage +=1;
        this.paginate();
      },
      getPreviousPage() {
        this.pagination.currentPage -=1;
        this.paginate();
      },
      paginate() {
        console.log(this.pagination.currentPage)
        console.log('get new results set & paginate');
      },
      getPage() {
        console.log(this.pagination.endPage)
      },
      sortList() {},
      sortCna() {
        const sortModifier = (this.sortBy.direction === 'asc') ? 1 : -1;
        this.CNAsList.sort((CNA1, CNA2) => {
          const upperCasedValue1 = CNA1[this.sortBy.field].toUpperCase();
          const upperCasedValue2 = CNA2[this.sortBy.field].toUpperCase();
          if (upperCasedValue1 < upperCasedValue2) {
            return -1 * sortModifier;
          }
          if (upperCasedValue1 > upperCasedValue2) {
            return 1 * sortModifier;
          }
          return 0;
        });

        this.paginate();
      },
    }
  };
</script>

<style lang="scss">
@import '@/assets/style/globals.scss';
@import '@/assets/style/elements/cveTableStacked.scss';

</style>