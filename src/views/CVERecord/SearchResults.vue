<template>
  <div id="cve-secondary-page-main-container">
    <div class="columns is-centered">
      <div class="column is-8-desktop cve-main-column-content-width">
        <main id="cve-main-page-content" role="main">
          <div class="content">
            <div v-if="useCveListSearchStore.showHelpText">
              <p class="has-text-centered">
                Please use the help text below the search box above to fix your keyword(s).
              </p></div>
            <div v-else>
              <div v-if="useCveListSearchStore.isSearching"
                class="cve-loading-message has-text-centered"
              >
                <span class="icon-text">
                  <span class="icon">
                    <span class="loader is-loading" />
                  </span>
                  <span>Please wait. Loading...</span>
                </span>
              </div>
              <div v-else>
                <div v-if="useCveListSearchStore.isSearchServerError" class="has-text-centered">
                  <h1 class="title is-4">Service is currently unavailable.</h1>
                  <p style="text-align: center;">Please
                    <span class="icon-text">
                      <a href="https://cveform.mitre.org/" target="_blank">report the issue
                        <span class="icon is-size-7 cve-icon-xxs">
                          <p id="extenalLink1" class="is-hidden">external site</p>
                          <font-awesome-icon icon="external-link-alt" aria-labelledby="extenalLink1" aria-hidden="false" focusable="false"/>
                        </span>
                      </a>
                    </span>
                    and try again later.<br/>Or, use
                    <a href="https://cve.mitre.org/cve/search_cve_list.html" target="_blank">Search CVE List on cve.mitre.org
                      <span class="icon is-size-7 cve-icon-xxs">
                        <p id="extenalLink1" class="is-hidden">external site</p>
                        <font-awesome-icon icon="external-link-alt" aria-labelledby="extenalLink1" aria-hidden="false" focusable="false"/>
                      </span>
                    </a>
                    to search CVE Records. Sorry for the inconvenience.
                  </p>
                </div>

                <div v-else>
                  <div v-if="Object.keys(useCveListSearchStore.recordData).length > 0">
                    <table class="table is-striped is-hoverable cve-border-dark-blue is-fullwidth mb-1">
                        <thead>
                          <tr>
                            <th scope="col" class="is-hidden-desktop" >CVE ID</th>
                            <th scope="col" class="is-hidden-touch" style="width: 20%">CVE ID</th>
                            <th scope="col" class="is-hidden-desktop" >CNA</th>
                            <th scope="col" class="is-hidden-touch" style="width: 20%">CNA</th>
                            <th scope="col">Description</th>
                          </tr>
                        </thead>
                        <tbody>
                          <tr class="cve-search-result" v-if="Object.keys(useCveListSearchStore.recordData).length > 0">
                            <td data-label="CVE ID" style="width: 20%">{{ useCveListSearchStore.recordData.cveId }}</td>
                            <td data-label="CNA" style="width: 20%">{{ useCveListSearchStore.recordData.cna }}</td>
                            <td data-label="Description">
                              <p v-for="description in useCveListSearchStore.recordData.descriptions" :key="description.key">{{ description }}</p>
                            </td>
                          </tr>
                        </tbody>
                    </table>
                    <hr/>
                  </div>
                  <div id="cve-search-results-container" v-if="useCveListSearchStore.totalSearchResultCount > 0">
                    <div>
                      <p>
                        <span>Showing </span>
                        <span class="has-text-weight-bold">
                          {{ ((useCveListSearchStore.pagination.currentPage * useCveListSearchStore.pagination.numberPerPage) - useCveListSearchStore.pagination.numberPerPage) + 1 }} - {{ ((useCveListSearchStore.pagination.currentPage * useCveListSearchStore.pagination.numberPerPage) - useCveListSearchStore.pagination.numberPerPage) + useCveListSearchStore.pagination.numberPerPage }}
                        </span>
                        <span> of </span>
                        <span class="has-text-weight-bold">
                          {{ useCveListSearchStore.totalSearchResultCount.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',') }}
                        </span>
                        <span> results for </span>
                        <span class="has-text-weight-bold">{{ useCveListSearchStore.query }}</span>
                      </p>
                    </div>
                    <div class="field is-grouped is-grouped-right">
                      <label class="label">Show:</label>
                      <div class="control">
                        <div class="select">
                          <select v-model="numberPerPage" aria-label="Select how many search results to show">
                            <option>25</option>
                            <option>50</option>
                            <option>100</option>
                            <option>150</option>
                            <option>200</option>
                          </select>
                        </div>
                      </div>
                      <label class="label">Sort by:</label>
                      <div class="control">
                        <div class="select">
                          <select name="partner" v-model="sortBy" aria-label="Select a sort by direction">
                            <option v-bind:value='{field: "cveId", direction: "desc"}'>CVE ID (newest to oldest)</option>
                            <option v-bind:value='{field: "cveId", direction: "asc"}'>CVE ID (oldest to newest)</option>
                            <option v-bind:value='{field: "relevancy", direction: "asc"}'>Relevancy (most to least)</option>
                            <option v-bind:value='{field: "relevancy", direction: "desc"}'>Relevancy (least to most)</option>
                          </select>
                        </div>
                      </div>
                    </div>
                    <nav class="pagination is-centered" role="navigation" aria-label="pagination">
                      <button @click=getPreviousPage
                        :disabled="useCveListSearchStore.pagination.currentPage <= 1 ? true : false"
                        :aria-disabled="useCveListSearchStore.pagination.currentPage <= 1 ? true : false"
                        class="pagination-previous"
                      >
                        Previous
                      </button>
                      <button @click=getNextPage
                        :disabled="useCveListSearchStore.pagination.currentPage < useCveListSearchStore.pagination.totalPages ? false : true"
                        :aria-disabled="useCveListSearchStore.pagination.currentPage < useCveListSearchStore.pagination.totalPages ? false : true"
                        class="pagination-next"
                      >
                        Next
                      </button>
                      <ul class="pagination-list">
                        <li v-for="page in useCveListSearchStore.pagination.currentPageWindow" :key="page.key">
                          <a
                            @click="getPage()"
                            :class="{'is-current': page === useCveListSearchStore.pagination.currentPage}"
                            class="pagination-link" :aria-label="`Go to page ${useCveListSearchStore.pagination.currentPage}`">
                            {{ page }}
                          </a>
                        </li>
                      </ul>
                    </nav>
                    <div v-if="Object.keys(useCveListSearchStore.recordData).length > 0 || useCveListSearchStore.totalSearchResultCount > 0"
                      class="table-container"
                    >
                      <table class="table is-striped is-hoverable cve-border-dark-blue is-fullwidth mb-1">
                        <thead>
                          <tr>
                            <th scope="col" class="is-hidden-desktop" >CVE ID</th>
                            <th scope="col" class="is-hidden-touch" style="width: 20%">CVE ID</th>
                            <th scope="col" class="is-hidden-desktop" >CNA</th>
                            <th scope="col" class="is-hidden-touch" style="width: 20%">CNA</th>
                            <th scope="col">Description</th>
                            <th scope="col" class="is-hidden-desktop" >Relevancy</th>
                            <th scope="col" class="is-hidden-touch" style="width: 20%">Relevancy</th>
                          </tr>
                        </thead>
                        <tbody>
                          <tr v-for="result in useCveListSearchStore.searchResults" :key="result.key">
                            <td data-label="CVE ID" style="width: 20%">{{ result.cveId }}</td>
                            <td data-label="CNA" style="width: 20%">{{ result.cna }}</td>
                            <td data-label="Description">
                              <p v-for="description in result.descriptions" :key="description.key">{{ description }}</p>
                            </td>
                            <td data-label="Relavancy Score" class="is-hidden-touch">{{ result.relevancyScore }}</td>
                          </tr>
                        </tbody>
                      </table>
                    </div>
                  </div>
                  <div v-else class="has-text-centered">
                    <p>No search results.</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </main>
      </div>
    </div>
  </div>
</template>

<script>
import { useCveListSearchStore } from '@/stores/cveListSearch';

  export default {
    name: 'SearchResults',
    data() {
      return {
        useCveListSearchStore: useCveListSearchStore(),
        totalExecutingRequests: useCveListSearchStore().totalExecutingRequests,
        numberPerPage: useCveListSearchStore().pagination.numberPerPage,
        sortBy: useCveListSearchStore().sortBy
      };
    },
    watch: {
      numberPerPage() {
        useCveListSearchStore().pagination.numberPerPage = this.numberPerPage;
        console.log(`numberPerPage() ${useCveListSearchStore().pagination.currentPage}, ${useCveListSearchStore().pagination.numberPerPage}`)
        useCveListSearchStore().paginate();
      },
      sortBy() {
        useCveListSearchStore().sortBy.field = this.sortBy.field;
        useCveListSearchStore().sortBy.direction = this.sortBy.direction;
        console.log('SearchResults.vue >> sortBy', this.sortBy);
        useCveListSearchStore().sortResults();
      }
    },
    methods: {
      getNextPage() {
        useCveListSearchStore().pagination.currentPage +=1;
        if ((useCveListSearchStore().pagination.currentPage > useCveListSearchStore().pagination.endWindow) && (useCveListSearchStore().pagination.currentPage <= useCveListSearchStore().pagination.totalPages)) {
          useCveListSearchStore().pagination.startWindow = useCveListSearchStore().pagination.currentPage;

          if (useCveListSearchStore().pagination.startWindow === useCveListSearchStore().pagination.totalPages) {
            useCveListSearchStore().pagination.endWindow = useCveListSearchStore().pagination.startWindow;
          } else if ((useCveListSearchStore().pagination.endWindow + useCveListSearchStore().pagination.maxPageWindow) < useCveListSearchStore().pagination.totalPages) {
            useCveListSearchStore().pagination.endWindow += useCveListSearchStore().pagination.maxPageWindow;
          } else if ((useCveListSearchStore().pagination.endWindow + useCveListSearchStore().pagination.maxPageWindow) > useCveListSearchStore().pagination.totalPages) {
            useCveListSearchStore().pagination.endWindow += (useCveListSearchStore().pagination.totalPages - useCveListSearchStore().pagination.startWindow);
          }

          useCveListSearchStore().pagination.currentPageWindow = this.calcRange(useCveListSearchStore().pagination.startWindow, useCveListSearchStore().pagination.endWindow, 1);
        }
        console.log(useCveListSearchStore().pagination.currentPage, useCveListSearchStore().pagination.startWindow, useCveListSearchStore().pagination.endWindow, )
        
        console.log(`getNextPage() >> `)
        console.log(useCveListSearchStore().pagination)

        useCveListSearchStore().paginate();
      },
      getPreviousPage() {

        useCveListSearchStore().pagination.currentPage -=1;

        if ((useCveListSearchStore().pagination.currentPage < useCveListSearchStore().pagination.startWindow) && (useCveListSearchStore().pagination.currentPage >= 1)) {
          useCveListSearchStore().pagination.endWindow = useCveListSearchStore().pagination.currentPage;

          if (useCveListSearchStore().pagination.maxPageWindow - useCveListSearchStore().pagination.endWindow === 0) {
            useCveListSearchStore().pagination.startWindow = 1;
          } else if ((useCveListSearchStore().pagination.endWindow - useCveListSearchStore().pagination.maxPageWindow) >= 10) {
            useCveListSearchStore().pagination.startWindow -= useCveListSearchStore().pagination.maxPageWindow;
          }

          useCveListSearchStore().pagination.currentPageWindow = this.calcRange(useCveListSearchStore().pagination.startWindow, useCveListSearchStore().pagination.endWindow, 1);
        }

        console.log(`getPreviousPage() >>`)
        console.log(useCveListSearchStore().pagination)

        useCveListSearchStore().paginate();
      },
      getPage() {
        console.log(`getPage()`, console.log(useCveListSearchStore().pagination.currentPage));
        useCveListSearchStore().paginate();
      },
      sortList() {},
      sortCna() {
        const sortModifier = (this.sortBy.direction === 'asc') ? 1 : -1;
        this.CNAsList.sort((CNA1, CNA2) => {
          const upperCasedValue1 = CNA1[this.sortBy.field].toUpperCase();
          const upperCasedValue2 = CNA2[this.sortBy.field].toUpperCase();
          if (upperCasedValue1 < upperCasedValue2) {
            return -1 * sortModifier;
          }
          if (upperCasedValue1 > upperCasedValue2) {
            return 1 * sortModifier;
          }
          return 0;
        });

        useCveListSearchStore().paginate();
      }, 
    }
  };
</script>

<style lang="scss">
@import '@/assets/style/globals.scss';
@import '@/assets/style/elements/cveTableStacked.scss';

</style>