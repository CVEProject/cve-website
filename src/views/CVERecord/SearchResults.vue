<template>
  <div id="cve-secondary-page-main-container">
    <div class="columns is-centered">
      <div class="column is-8-desktop cve-main-column-content-width">
        <main id="cve-main-page-content" role="main">
          <div class="content">
            <div v-if="useCveListSearchStore.showHelpText">
              <p class="has-text-centered">
                Please use the help text below the search box above to fix your keyword(s).
              </p></div>
            <div v-else>
              <div v-if="useCveListSearchStore.cveRecordIsLoading || useCveListSearchStore.searchResultIsLoading"
                class="cve-loading-message has-text-centered"
              >
                <span class="icon-text">
                  <span class="icon">
                    <span class="loader is-loading" />
                  </span>
                  <span>Please wait. Loading...</span>
                </span>
              </div>
              <div v-else>
                <div v-if="useCveListSearchStore.isSearchServerError" class="has-text-centered">
                  <h1 class="title is-4">Service is currently unavailable.</h1>
                  <p style="text-align: center;">Please
                    <span class="icon-text">
                      <a href="https://cveform.mitre.org/" target="_blank">report the issue
                        <span class="icon is-size-7 cve-icon-xxs">
                          <p id="extenalLink1" class="is-hidden">external site</p>
                          <font-awesome-icon icon="external-link-alt" aria-labelledby="extenalLink1" aria-hidden="false" focusable="false"/>
                        </span>
                      </a>
                    </span>
                    and try again later.<br/>Or, use
                    <a href="https://cve.mitre.org/cve/search_cve_list.html" target="_blank">Search CVE List on cve.mitre.org
                      <span class="icon is-size-7 cve-icon-xxs">
                        <p id="extenalLink1" class="is-hidden">external site</p>
                        <font-awesome-icon icon="external-link-alt" aria-labelledby="extenalLink1" aria-hidden="false" focusable="false"/>
                      </span>
                    </a>
                    to search CVE Records. Sorry for the inconvenience.
                  </p>
                </div>
                <div v-else>
                  <div v-if="useCveListSearchStore.totalSearchResultCount <= 0" class="has-text-centered">
                    <p>No search results.</p>
                  </div>
                  <div v-else>
                    <div>
                      <p>
                        <span>Showing </span>
                        <span class="has-text-weight-bold">
                          {{ (pagination.currentPage * numberPerPage) + 1 }} - {{ (pagination.currentPage * numberPerPage) + numberPerPage }}
                        </span>
                        <span> of </span>
                        <span class="has-text-weight-bold">
                          {{ useCveListSearchStore.totalSearchResultCount.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',') }}
                        </span>
                        <span> results for </span>
                        <span class="has-text-weight-bold">{{ useCveListSearchStore.query }}</span>
                      </p>
                    </div>
                    <div class="field is-grouped is-grouped-right">
                      <label class="label">Show:</label>
                      <div class="control">
                        <div class="select">
                          <select v-model="numberPerPage" aria-label="Select how many search results to show">
                            <option>25</option>
                            <option>50</option>
                            <option>100</option>
                            <option>150</option>
                            <option>200</option>
                          </select>
                        </div>
                      </div>
                      <label class="label">Sort by:</label>
                      <div class="control">
                        <div class="select">
                          <select name="partner" v-model="sortBy" aria-label="Select a sort by direction">
                            <option v-bind:value='{field: "cveId", direction: "asc"}'>CVE ID (newest to oldest)</option>
                            <option v-bind:value='{field: "cveId", direction: "desc"}'>CVE ID (oldest to newest)</option>
                            <option v-bind:value='{field: "relevancy", direction: "asc"}'>Relevancy (most to least)</option>
                            <option v-bind:value='{field: "relevancy", direction: "desc"}'>Relevancy (least to most)</option>
                          </select>
                        </div>
                      </div>
                    </div>
                    <nav class="pagination is-centered" role="navigation" aria-label="pagination">
                      <button @click=getPreviousPage
                        :disabled="pagination.currentPage <= 1 ? true : false"
                        :aria-disabled="pagination.currentPage <= 1 ? true : false"
                        class="pagination-previous"
                      >
                        Previous
                      </button>
                      <button @click=getNextPage
                        :disabled="pagination.currentPage < pagination.totalPages ? false : true"
                        :aria-disabled="pagination.currentPage < pagination.totalPages ? false : true"
                        class="pagination-next"
                      >
                        Next
                      </button>
                      <ul class="pagination-list">
                        <li v-for="page in pagination.currentPageWindow" :key="page.key">
                          <a
                            :class="{'is-current': page === pagination.currentPage}"
                            class="pagination-link" :aria-label="`Goto page ${pagination.currentPage}`">
                            {{ page }}
                          </a>
                        </li>
                      </ul>
                    </nav>
                    <div v-if="Object.keys(useCveListSearchStore.recordData).length > 0 || useCveListSearchStore.totalSearchResultCount > 0"
                      class="table-container"
                    >
                      <table class="table is-striped is-hoverable cve-border-dark-blue is-fullwidth mb-1">
                        <thead>
                          <tr>
                            <th scope="col" class="is-hidden-desktop" >CVE ID</th>
                            <th scope="col" class="is-hidden-touch" style="width: 20%">CVE ID</th>
                            <th scope="col" class="is-hidden-desktop" >CNA</th>
                            <th scope="col" class="is-hidden-touch" style="width: 20%">CNA</th>
                            <th scope="col">Description</th>
                            <th scope="col" class="is-hidden-desktop" >Relevancy</th>
                            <th scope="col" class="is-hidden-touch" style="width: 20%">Relevancy</th>
                          </tr>
                        </thead>
                        <tbody>
                          <tr class="cve-search-result" v-if="Object.keys(useCveListSearchStore.recordData).length > 0">
                            <td data-label="CVE ID" class="is-hidden-touch">{{ useCveListSearchStore.recordData.cveId }}</td>
                            <td data-label="CNA" class="is-hidden-touch">{{ useCveListSearchStore.recordData.cna }}</td>
                            <td data-label="Description">
                              <p v-for="description in useCveListSearchStore.recordData.descriptions" :key="description.key">{{ description }}</p>
                            </td>
                            <td data-label="Relavancy Score" class="is-hidden-touch">{{ useCveListSearchStore.recordData.relevancyScore }}</td>
                          </tr>
                          <tr v-for="result in useCveListSearchStore.searchResults" :key="result.key">
                            <td data-label="CVE ID" style="width: 20%">{{ result.cveId }}</td>
                            <td data-label="CNA" style="width: 20%">{{ result.cna }}</td>
                            <td data-label="Description">
                              <p v-for="description in result.descriptions" :key="description.key">{{ description }}</p>
                            </td>
                            <td data-label="Relavancy Score" class="is-hidden-touch">{{ result.relevancyScore }}</td>
                          </tr>
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </main>
      </div>
    </div>
  </div>
</template>

<script>
  import { useCveListSearchStore } from '@/stores/cveListSearch';

  export default {
    name: 'SearchResults',
    data() {
      return {
        isMessageExpanded: false,
        useCveListSearchStore: useCveListSearchStore(),
        numberPerPage: 25,
        sortBy: {
          field: 'cveId',
          direction: 'asc',
        },
        pagination: {
          startWindow: 1,
          endWindow: undefined,
          currentPage: 1,
          currentPageWindow: [],
          totalPages: undefined,
          maxPageWindow: 10,
        },
      };
    },
    beforeMount(){
      this.calcTotalPages();
      console.log(this.pagination.totalPages)
    },
    watch: {
      numberPerPage() {
        this.calcTotalPages();
        this.getPage();
      },
      sortBy() {}
    },
    methods: {
      calcTotalPages() {

        this.pagination.totalPages = Math.floor(useCveListSearchStore().totalSearchResultCount / this.numberPerPage);
        if (this.pagination.totalPages >= this.pagination.maxPageWindow) {
          this.pagination.endWindow = this.pagination.maxPageWindow;
        } else if((this.pagination.totalPages > 0) && (this.pagination.totalPages < this.pagination.maxPageWindow)) {
          this.pagination.endWindow = this.pagination.totalPages;
        } 

        if (this.pagination?.startWindow && this.pagination?.endWindow) {
          this.pagination.currentPageWindow = this.calcRange(this.pagination.startWindow, this.pagination.endWindow, 1);
        }
      },
      getNextPage() {
        this.pagination.currentPage +=1;
        if ((this.pagination.currentPage > this.pagination.endWindow) && (this.pagination.currentPage <= this.pagination.totalPages)) {
          this.pagination.startWindow = this.pagination.currentPage;

          if (this.pagination.startWindow === this.pagination.totalPages) {
            this.pagination.endWindow = this.pagination.startWindow;
          } else if ((this.pagination.endWindow + this.pagination.maxPageWindow) < this.pagination.totalPages) {
            this.pagination.endWindow += this.pagination.maxPageWindow;
          } else if ((this.pagination.endWindow + this.pagination.maxPageWindow) > this.pagination.totalPages) {
            this.pagination.endWindow += (this.pagination.totalPages - this.pagination.startWindow);
          }

          this.pagination.currentPageWindow = this.calcRange(this.pagination.startWindow, this.pagination.endWindow, 1);
        }
        console.log(this.pagination.currentPage, this.pagination.startWindow, this.pagination.endWindow, )
        this.paginate();
      },
      getPreviousPage() {
        this.pagination.currentPage -=1;

        if ((this.pagination.currentPage < this.pagination.startWindow) && (this.pagination.currentPage >= 1)) {
          this.pagination.endWindow = this.pagination.currentPage;

          if (this.pagination.maxPageWindow - this.pagination.endWindow === 0) {
            this.pagination.startWindow = 1;
          } else if ((this.pagination.endWindow - this.pagination.maxPageWindow) >= 10) {
            this.pagination.startWindow -= this.pagination.maxPageWindow;
          }

          this.pagination.currentPageWindow = this.calcRange(this.pagination.startWindow, this.pagination.endWindow, 1);
        }
        this.paginate();
      },
      paginate() {
        console.log(this.pagination.currentPage)
        console.log('get new results set & paginate');
      },
      getPage() {
        console.log(this.pagination.totalPages)
      },
      sortList() {},
      sortCna() {
        const sortModifier = (this.sortBy.direction === 'asc') ? 1 : -1;
        this.CNAsList.sort((CNA1, CNA2) => {
          const upperCasedValue1 = CNA1[this.sortBy.field].toUpperCase();
          const upperCasedValue2 = CNA2[this.sortBy.field].toUpperCase();
          if (upperCasedValue1 < upperCasedValue2) {
            return -1 * sortModifier;
          }
          if (upperCasedValue1 > upperCasedValue2) {
            return 1 * sortModifier;
          }
          return 0;
        });

        this.paginate();
      },
      calcRange(start, stop, step) {
        let newArr = Array.from({ length: (stop - start) / step + 1 }, (_, i) => start + i * step);
        return newArr
      }
    }
  };
</script>

<style lang="scss">
@import '@/assets/style/globals.scss';
@import '@/assets/style/elements/cveTableStacked.scss';

</style>