 <template>
  <div class="content">
    <nav class="level mb-0">
      <div class="level-left">
        <div class="level-item">
          <h1 class="title">{{this.$store.state.cveId}}</h1>
        </div>
        <div v-if="cveFieldList.state.length > 0" class="level-item">
          <span class="tag is-info">{{cveFieldList.state}}</span>
        </div>
      </div>
      <div class="level-right ml-1">
        <div class="level-item is-size-7">
          <a id="cve-view-json" :href="`${this.$store.state.CVE_SERVICES_API_BASE}/api/cve/${this.$store.state.cveId}`" target="_blank">
            View JSON
          </a>
        </div>
      </div>
    </nav>
    <div class="content"><span v-if="cveFieldList.title.length > 0" class="has-text-grey-dark is-size-6">{{cveFieldList.title}}</span></div>
    <div id="cve-cna-container" class="content">
      <p v-if="cveFieldList.assigner.length > 0" class="mb-0">
        <span class="has-text-weight-bold">Assigner: </span>
        <span style="text-transform: capitalize;">{{cveFieldList.assigner}}</span>
      </p>
      <div id="cve-record-dates-and-tags-container" class="has-text-grey-dark has-text-left">
        <span class="mr-2">
          <span  v-if="cveFieldList.datePublishedCveMetadata.length > 0">
            <span class="has-text-weight-semibold">Published: </span>
            <time>{{cveFieldList.datePublishedCveMetadata}}</time>
          </span>
          <span :class="cveFieldList.datePublishedCveMetadata.length > 0 ? 'ml-2' : ''" v-if="cveFieldList.dateUpdatedCveMetadata.length > 0">
            <span class="has-text-weight-semibold">Updated: </span>
            <time>{{cveFieldList.dateUpdatedCveMetadata}}</time>
          </span>
        </span>
        <span id="cve-tag " v-if="cveFieldList.tags.length > 0">
          <span class="has-text-grey-dark mr-2">|</span>
          <span class="tag is-info is-light" v-for="tag in cveFieldList.tags" :key="tag">{{tag}}</span>
        </span>
      </div>
    </div>
    <div id="cve-desciption" class="content has-text-justified">
      <p v-for="description in cveFieldList.descriptions" :key="description">{{description}}</p>
    </div>
    <div id="cve-product-status-container" class="content" v-if="cveFieldList.productsStatus.length > 0">
      <h2 class="title is-size-5">Product Status</h2>
      <div class="columns cve-row mb-4" v-for="(product, index) in cveFieldList.productsStatus" :key="`${index}-${product.vendor}`">
        <div id="cve-vendor-product-platforms" class="column is-4 cve-light-gray-bg">
          <p class="has-text-weight-bold">Product</p>
          <p id="cve-vendor" v-if="product.vendor.length > 0">{{product.vendor}}</p>
          <p id="cve-product" v-if="product.product.length > 0">{{product.product}}</p>
          <p id="cve-platforms" v-if="product.platforms.length > 0">
            <span class="has-text-weight-bold">Platforms: </span>
            {{product.platforms.join(', ')}}
          </p>
        </div>
        <div class="column is-8 cve-light-gray-bg cve-left-margin cve-top-margin">
          <div class="columns">
            <div id="cve-affected-version" class="column" v-if="product.affected.length > 0">
              <p class="has-text-weight-bold">Affected</p>
              <p v-for="affect in product.affected" :key="affect">{{affect}}</p>
            </div>
            <div id="cve-unaffected-version" class="column" v-if="product.unaffected.length > 0">
              <p class="has-text-weight-bold">Unaffected</p>
              <p v-for="unaffected in product.unaffected" :key="unaffected">{{unaffected}}</p>
            </div>
            <div id="cve-unknown-version" class="column" v-if="product.unknown.length > 0">
              <p class="has-text-weight-bold">Unknown</p>
              <p v-for="unknown in product.unknown" :key="unknown">{{unknown}}</p>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div id="cve-credits" class="content" v-if="cveFieldList.credits.length > 0">
      <h2 class="title is-size-5">Credits</h2>
      <ul>
        <li v-for="(credit, index) in cveFieldList.credits" :key="`${credit}-${index}`">
          {{credit.value}}
          <span class="tag ml-2" v-if="typeof credit.type !== 'undefined' && credit.type.length > 0">{{credit.type}}</span>
        </li>
      </ul>
    </div>
    <div id="cve-references" class="content" v-if="cveFieldList.references.length > 0">
      <h2 class="title is-size-5">References</h2>
      <ul>
        <li v-for="(reference, index) in cveFieldList.references" :key="`link-${index}`" class="cve-word-wrap">
          <span class="icon-text">
            <a :href="reference.url" target="_blank">
              {{ (typeof reference.name !== 'undefined' && reference.name.length > 0) ? reference.name : reference.url }}
              <span class="icon cve-icon-xxs">
                <p id="enewsletter" class="is-hidden">external site</p>
                <font-awesome-icon icon="external-link-alt" aria-labelledby="enewsletter"></font-awesome-icon>
              </span>
            </a>
          </span>
          <span v-for="tag in reference.tags" :key="tag">
            <span class="tag ml-2" v-if="tag.length > 0">{{tag}}</span>
          </span>
        </li>
      </ul>
    </div>
    <div id="cve-nvd-link">
      <span>View additional information about
        <a :href="`${NVDBaseUrl}${this.$store.state.cveId}`" target='_blank'>
          {{ this.$store.state.recordData.cveMetadata.cveId }}
          <span class='icon cve-icon-xxs'>
            <p id='nvd' class='is-hidden'>external site</p>
            <font-awesome-icon icon='external-link-alt' aria-labelledby='nvd'></font-awesome-icon>
          </span>
        </a>
        on NVD.
      </span>
      <p class='cve-help-text'>(Note: The NVD is not operated by the CVE Program)</p>
    </div>
  </div>
</template>

<script>
import Vue from 'vue';
import _ from 'lodash';

export default ({
  name: 'PublishedRecord',
  props: {
    NVDBaseUrl: {
      type: String,
      required: true,
    },
  },
  data() {
    return {
      cveRecordFields: ['ID', 'CNA', 'Credits', 'Description', 'References', 'State', 'Tags', 'Title', 'VendorsProductsVersions',
        'RecordPublishedDate', 'RecordUpdatedDate'],
      cveFieldList: {
        cveId: '',
        credits: [],
        descriptions: [],
        productsStatus: [],
        title: '',
        state: '',
        assigner: '',
        dateUpdatedCveMetadata: '',
        datePublishedCveMetadata: '',
        references: [],
        tags: [],
      },
      originalRecordData: this.$store.state.recordData || {},
    };
  },
  methods: {
    initializeFields() {
      this.cveRecordFields.forEach((field) => {
        this.getContentForField(field);
      });
    },
    getCNA() {
      const value = this.originalRecordData.cveMetadata?.assignerShortName;
      if (this.hasData(value)) {
        this.cveFieldList.assigner = value.replace('_', ' ');
      }
    },
    getCredits() {
      // schema: https://github.com/CVEProject/cve-schema/blob/master/schema/v5.0/CVE_JSON_5.0_schema.json#L971-L1015
      const value = this.originalRecordData.containers?.cna?.credits;
      if (this.hasData(value)) {
        value.forEach((credit) => {
          if (this.isEnglishLanguage(credit.lang)) {
            this.cveFieldList.credits.push(credit);
          }
        });
      }
    },
    getRecordPublishedDate() {
      const value = this.originalRecordData.cveMetadata?.datePublished;
      if (this.hasData(value)) {
        this.cveFieldList.datePublishedCveMetadata = this.getDate(value);
      }
    },
    getRecordUpdatedDate() {
      const value = this.originalRecordData.cveMetadata?.dateUpdated;
      if (this.hasData(value)) {
        this.cveFieldList.dateUpdatedCveMetadata = this.getDate(value);
      }
    },
    getCVEid() {
      const value = this.originalRecordData.cveMetadata?.cveId;
      if (this.hasData(value)) {
        this.cveFieldList.cveId = value;
      } else {
        this.cveFieldList.cveId = this.$store.state.recordData.cveMetadata.cveId; // user-provided CVE ID
      }
    },
    getDescription() {
      const value = this.originalRecordData.containers?.cna?.descriptions;
      if (this.hasData(value)) {
        value.forEach((desc) => {
          if (this.isEnglishLanguage(desc.lang)) {
            this.cveFieldList.descriptions.push(desc.value);
          }
        });
      }
    },
    getReferences() {
      const value = this.originalRecordData.containers?.cna?.references;
      if (this.hasData(value)) {
        const filteredReferences = [];
        const regex = /^x_refsource/;

        value.forEach((reference) => {
          let newReference = {};
          const filteredTags = [];

          reference.tags.forEach((tag) => {
            if (!regex.test(tag)) filteredTags.push(tag);
          });
          newReference = _.cloneDeep(reference);
          newReference.tags = filteredTags;
          filteredReferences.push(newReference);
        });

        Vue.set(this.cveFieldList, 'references', filteredReferences);
      }
    },
    getState() {
      const value = this.originalRecordData.cveMetadata?.state;
      if (this.hasData(value)) {
        this.cveFieldList.state = value;
      }
    },
    getTags() {
      const value = this.originalRecordData.containers?.cna?.tags;
      if (this.hasData(value)) {
        Vue.set(this.cveFieldList, 'tags', value);
      }
    },
    getTitle() {
      const value = this.originalRecordData.containers?.cna?.title;
      if (this.hasData(value)) {
        this.cveFieldList.title = value;
      }
    },
    getProductsStatus() {
      const value = this.originalRecordData.containers?.cna?.affected;
      if (this.hasData(value)) {
        const prodStatusTemplate = {
          vendor: '',
          product: '',
          platforms: [],
          affected: [],
          unaffected: [],
          unknown: [],
        };

        value.forEach((affectedObj) => {
          const prodStatus = _.cloneDeep(prodStatusTemplate);
          if (this.hasData(affectedObj?.vendor)) prodStatus.vendor = affectedObj.vendor;
          if (this.hasData(affectedObj?.product)) prodStatus.product = affectedObj.product;
          if (this.hasData(affectedObj?.platforms)) prodStatus.platforms = _.cloneDeep(affectedObj.platforms);
          // https://github.com/Vulnogram/seaview/blob/main/script.js#L175-L216
          if (this.hasData(affectedObj?.versions)) {
            affectedObj.versions.forEach((version) => {
              const fromVersion = `>= ${version?.version || 'no version provided'}`;

              if (this.hasData(version?.changes)) {
                let previousStatus = version?.status || 'no previous version provided';
                let previousVersion = version?.version || 'no version provided';
                version.changes.forEach((versionChange) => {
                  const atVersion = versionChange.at || 'no at version provided';
                  prodStatus[previousStatus].push(`>= ${previousVersion} to < ${atVersion}`);
                  previousStatus = versionChange?.status || 'no previous version provided';
                  previousVersion = atVersion;
                });

                if (affectedObj?.lessThan) {
                  const currentVersion = `>= ${previousVersion} ${(affectedObj.lessThan !== previousVersion ? `to < ${affectedObj.lessThan}` : '')}`;
                  prodStatus[previousStatus].push(currentVersion);
                } else if (affectedObj?.lessThanOrEqual) {
                  const currentVersion = `>= ${previousVersion} ${(affectedObj.lessThanOrEqual !== previousVersion
                    ? `to < ${affectedObj.lessThanOrEqual}` : '')}`;
                  prodStatus[previousStatus].push(currentVersion);
                } else {
                  prodStatus[previousStatus].push(`> ${previousVersion}`);
                }
              } else {
                if (this.hasData(version?.lessThan)) {
                  const lessThanVersion = `to < ${version?.lessThan || 'no version lessThan provided'}`;
                  prodStatus[version?.status || 'versionStatus'].push(`${fromVersion} ${lessThanVersion}`);
                } else if (this.hasData(version?.lessThanOrEqual)) {
                  const lessThanOrEqualVersion = `to <= ${version.lessThanOrEqual || 'no version lessThanOrEqual provided'}`;
                  prodStatus[version?.status || 'versionStatus'].push(`${fromVersion} ${lessThanOrEqualVersion}`);
                } else {
                  prodStatus[version?.status || 'versionStatus'].push(`= ${version?.version}`);
                }
              }
            });
          }

          this.cveFieldList.productsStatus.push(_.cloneDeep(prodStatus));
        });
      }
    },
    getContentForField(field) {
      switch (field) {
        case 'CNA':
          this.getCNA();
          break;
        case 'Credits':
          this.getCredits();
          break;
        case 'Description':
          this.getDescription();
          break;
        case 'ID':
          this.getCVEid();
          break;
        case 'RecordPublishedDate':
          this.getRecordPublishedDate();
          break;
        case 'RecordUpdatedDate':
          this.getRecordUpdatedDate();
          break;
        case 'References':
          this.getReferences();
          break;
        case 'State':
          this.getState();
          break;
        case 'Tags':
          this.getTags();
          break;
        case 'Title':
          this.getTitle();
          break;
        case 'VendorsProductsVersions':
          this.getProductsStatus();
          break;
        default:
          break;
      }
    },
    hasData(value) {
      if (typeof value !== 'undefined' && value.length > 0) {
        return true;
      }

      return false;
    },
    isEnglishLanguage(lang) {
      const regex = /^(en)/;
      const isEnglishLanguage = regex.test(lang);

      return isEnglishLanguage;
    },
    getDate(dateTime) {
      const [date] = dateTime.split('T');
      return date;
    },
    toggleRecord() {
      this.$store.commit('updateState', { showJsonRecord: !this.$store.state.showJsonRecord });
    },
  },
  beforeMount() {
    this.initializeFields();
  },
});
</script>

<style lang="scss">
@import '@/assets/style/globals.scss';
@import '@/assets/style/cveRecord.scss';

.cve-light-gray-bg {
  background-color: #FFF;
  border-radius: $cve-border-radius;
  border: $white-ter solid 1px;
}

.columns {
  margin-top: 0rem !important;
}

.columns:not(:last-child) {
    margin-bottom: 0.5rem !important;
}

.cve-row {
  border: $white-ter solid 2px;
  margin-left: unset !important;
  margin-right: unset !important;
}
</style>
