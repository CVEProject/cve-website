 <template>
  <div class="content">
    <nav class="level mb-0">
      <div class="level-left">
        <div class="level-item">
          <h1 class="title">{{useCveRecordLookupStore.cveId}}</h1>
        </div>
        <div v-if="cveFieldList.state.length > 0" class="level-item">
          <span class="tag is-info is-light has-text-weight-bold cve-state-tag">{{cveFieldList.state}}</span>
        </div>
      </div>
      <div class="level-right ml-1">
        <div class="level-item">
          <a id="cve-view-json" :href="`https://${cveServicesBaseUrl}/api/cve/${useCveRecordLookupStore.cveId}`" target="_blank">
            View JSON
          </a>
        </div>
      </div>
    </nav>
    <div id="cve-record-format-info" role="information" class="notification is-info is-light p-3">
      <div class="is-flex" style="justify-content: center;">
          <section class="cve-accordian" style="flex: 0 0 100%;">
              <div class="message" style="background: transparent !important;">
                <div class="message-header p-0"
                  style="background: transparent !important;border-bottom: unset !important">
                  <span class="icon-text">
                    <span class="icon">
                      <p id="infoIconVariousFormts" class="is-hidden">information</p>
                      <font-awesome-icon style="flex: 0 0 40px;" size="1x"  icon="info-circle" role="alert"
                        aria-labelledby="alertIconVariousFormts" aria-hidden="false" />
                    </span>
                    <span class="mr-1">Important CVE Record Format Information</span>
                  </span>
                  <button class="button message-header-button" style="background: transparent !important;"
                    @click="isMessageExpanded = !isMessageExpanded">
                    <span class="icon is-small">
                      <p id="expandCollapseAltText" class="is-hidden">
                        {{isMessageExpanded ? 'expand': 'collapse'}}
                      </p>
                      <font-awesome-icon :icon="isMessageExpanded ? 'minus' : 'plus'"
                        aria-hidden="false" focusable="true" aria-labelledby="expandCollapseAltText"/>
                    </span>
                  </button>
                </div>
              </div>
          </section>
      </div>
      <div id="cve-record-format-info-content" v-if="isMessageExpanded" class="p-4 has-text-justified">
        <p>
          <router-link to='/ResourcesSupport/Glossary?activeTerm=glossaryRecord'>CVE Records</router-link>
          on this CVE.ORG website are displayed in the official
          <router-link to='/AllResources/CveServices#CveRecordFormat'>CVE Record Format</router-link>.
          Downloads in this format are available on the <router-link to='/Downloads'>Downloads</router-link>
          page. Learn more about the CVE Record Format
          <router-link to='/AllResources/CveServices#CveRecordFormat'>here</router-link>.
        </p>
      </div>
    </div>
    <div id="cve-tabs-cna-adp" class="tabs">
      <ul class="ml-1">
        <li v-for="(isActive, roleName) in roleTabs" :key="roleName.key" :class="isActive ? 'is-active' : ''"> 
          <button @click="toggleRoleTab(roleName)"
            class="button" :class="isActive ? 'cve-tab-active' : 'cve-tab'"
          >
            <h2 class="title is-5">{{ roleName }}</h2>
          </button>
        </li>
      </ul>
    </div>
    <div v-if="roleTabs['CNA']" id="cve-tab-cna">
      <div id="cve-record-general-info-container" class="content">
        <nav id="cve-record-assginer-dates-container" class="level mb-0">
          <div class="level-left">
            <div v-if="cveFieldList.assigner.length > 0" class="level-item">
              <p class="mb-0">
                <span class="has-text-weight-bold">Assigner: </span>
                <span style="text-transform: capitalize;">{{cveFieldList.assigner}}</span>
              </p>
            </div>
            <div v-if="cveFieldList.datePublishedCveMetadata.length > 0" class="level-item">
              <span>
                <span class="has-text-weight-semibold">Published: </span>
                <time>{{cveFieldList.datePublishedCveMetadata}}</time>
              </span>
            </div>
            <div v-if="cveFieldList.dateUpdatedCveMetadata.length > 0" class="level-item">
              <span :class="cveFieldList.datePublishedCveMetadata.length > 0 ? 'ml-2' : ''">
              <span class="has-text-weight-semibold">Updated: </span>
              <time>{{cveFieldList.dateUpdatedCveMetadata}}</time>
            </span>
            </div>
          </div>
        </nav>
        <nav v-if="cveFieldList.title.length > 0" id="cve-record-title-container" class="level mb-0">
          <div class="level-left">
            <div class="level-item">
              <p class="mb-0">
                <span class="has-text-weight-bold">Title: </span>
                <span style="text-transform: capitalize;">{{ cveFieldList.title }}</span>
              </p>
            </div>
          </div>
        </nav>
        <nav v-if="cveFieldList.tags.length > 0" id="cve-record-title-tags-container" class="level mb-0">
          <div class="level-right ml-1">
            <div class="level-item">
              <span class="has-text-weight-semibold mr-1">Tags: </span>
              <span id="cve-tags">
                <span class="tag is-info is-light cve-tag" v-for="tag in cveFieldList.tags" :key="tag">{{tag}}</span>
              </span>
            </div>
          </div>
        </nav>
      </div>
      <div id="cve-desciption" class="content cve-x-scroll">
        <p v-for="description in cveFieldList.descriptions" :key="description">{{description}}</p>
      </div>
      <CvssCwe id="cve-cna-container" :containerObject="cnaContainer"></CvssCwe>
      <div id="cve-product-status-container" class="content">
        <h3 class="title is-size-5">Product Status</h3>
        <div role="information" class="notification is-info is-light p-3">
          <div class="is-flex" style="justify-content: center;">
              <section class="cve-accordian" style="flex: 0 0 100%;">
                  <div class="message" style="background: transparent !important;">
                    <div class="message-header p-0"
                      style="background: transparent !important;border-bottom: unset !important">
                      <span class="icon-text">
                        <span class="icon">
                          <p id="infoIconVariousFormts" class="is-hidden">information</p>
                          <font-awesome-icon style="flex: 0 0 40px;" size="1x"  icon="info-circle" role="alert"
                            aria-labelledby="alertIconVariousFormts" aria-hidden="false" />
                        </span>
                        <p class="mr-1">Learn About the Versions Section</p>
                      </span>
                      <button class="button message-header-button" style="background: transparent !important;"
                        @click="isHelpTestShown = !isHelpTestShown">
                          <span class="icon is-small">
                            <p id="expandCollapseVersionsAltText" class="is-hidden">
                              {{isHelpTestShown ? 'expand': 'collapse'}}
                            </p>
                            <font-awesome-icon :icon="isHelpTestShown ? 'minus' : 'plus'"
                              aria-hidden="false" focusable="true" aria-labelledby="expandCollapseVersionsAltText"/>
                          </span>
                      </button>
                    </div>
                  </div>
              </section>
          </div>
          <div v-if="isHelpTestShown" class="p-4 has-text-justified">
            <p>
              The <span class="has-text-weight-bold">Versions</span> section may contain a <span class="has-text-weight-bold">Default Status</span>
              field and one or more of these version status categories:
            </p>
            <div class="columns">
                <div v-for="status in ['Affected', 'Unaffected', 'Unknown']" :key="status.key"
                  class="column cve-top-margin cve-versions-column">
                  <div class="menu has-text-centered" style="border: unset !important">
                    <span class="has-text-weight-bold">{{status}}</span> Versions List
                  </div>
                </div>
              </div>
            <p>
              Each category contains a list with the following format:
              <ul>
                <li>
                  Top-level
                  <a href="https://github.com/CVEProject/cve-schema/blob/master/schema/v5.0/docs/versions.md#versions-and-version-ranges"
                  target="_blank">version/version range</a> is marked with a solid circle bullet.
                  <ul>
                    <li>
                      <a href="https://github.com/CVEProject/cve-schema/blob/master/schema/v5.0/docs/versions.md#version-status-changes"
                      target="_blank">Version changes</a> are marked with an outlined circle bullet.
                    </li>
                  </ul>
                </li>
              </ul>
            </p>
            <p><span class="cve-version">Purple text</span> denotes the version provided by the user inputting the CVE JSON 5.0 data.</p>
          <!-- <h4 class="title">Version Details</h4> -->
            <p>
              In the following section you will find the descriptions, format information and examples for the following fields: default status,
              top-level version/version range and version changes.
            </p>
            <p class="is-size-5">Default Status</p>
            <p>
              This status applies to all versions not explicitly mentioned elsewhere.
              <a href="https://github.com/CVEProject/cve-schema/blob/master/schema/v5.0/docs/versions.md#version-status-decisions" target="_blank">
              Learn more.</a>
            </p>
            <p class="is-size-5">Top-level Version/Version Range</p>
            <p>The single version being described, or the version range. By convention, 0 typically denotes the earliest possible version.</p>
            <p class="is-size-6 has-text-weight-bold">Formats:</p>
            <ul>
              <li>
                &lt;status: affected, unaffected, unknown&gt; at <span class="cve-version">&lt;version&gt;</span>
              </li>
              <li>
                &lt;status: affected, unaffected, unknown&gt; from <span class="cve-version">&lt;start version&gt;</span> &lt;at, before, through&gt;
                <span class="cve-version">&lt;end version&gt;</span>
              </li>
            </ul>
            <p class="is-size-6 has-text-weight-bold">Examples:</p>
            <ul>
              <li>
                <span class="has-text-weight-bold">unknown at <span class="cve-version">5.0</span></span>
                <span class="is-italic"> (unknown version is 5.0)</span>
              </li>
              <li>
                <span class="has-text-weight-bold">
                  affected from <span class="cve-version">5.0</span> before <span class="cve-version">6.0</span></span>
                <span class="is-italic"> (affected version doesn’t include 6.0)</span>
              </li>
              <li>
                <span class="has-text-weight-bold">
                  unaffected from <span class="cve-version">5.0</span> through <span class="cve-version">6.0</span>
                </span>
                <span class="is-italic"> (unaffected version range includes 5.0 and 6.0)</span>
              </li>
            </ul>
            <p class="is-size-5">Version changes</p>
            <p>
              A list of status changes that take place during a range. The list should be sorted in (linearly or topologically) increasing order by the
              'at' field, according to the <span class="is-italic">versionType</span>, but the user must not assume this. Instead, users must re-sort
              the list themselves before using it.
            </p>
            <p class="is-size-6 has-text-weight-bold">Format:</p>
            <p>&lt;status: affected, unaffected, unknown&gt; from <span class="cve-version">&lt;version&gt;</span></p>
            <p class="is-size-6 has-text-weight-bold">Examples:</p>
            <ul>
              <li>
                <span class="has-text-weight-bold">affected from <span class="cve-version">1.0</span> before <span class="cve-version">4.0</span></span>
                <span class="is-italic"> (affected version doesn't include 4.0)</span>
                <ul>
                  <li>
                    <span class="has-text-weight-bold">unaffected from <span class="cve-version">1.0</span></span>
                    <span class="is-italic"> (version affected changed and it is unaffected from 1.0 to 2.0 — the next range right below)</span>
                  </li>
                  <li>
                    <span class="has-text-weight-bold">affected from <span class="cve-version">2.0</span></span>
                    <span class="is-italic"> (version remain affected from 2.0 to before 4.0, not including 4.0)</span>
                  </li>
                </ul>
              </li>
              <li>
                For another linear version example view the
                <a href="https://github.com/CVEProject/cve-schema/blob/master/schema/v5.0/docs/versions.md#version-status-changes" target="_blank">
                  Version Status Changes
                </a> section
              </li>
              <li>
                For a non-linear version example view the
                <a href="https://github.com/CVEProject/cve-schema/blob/master/schema/v5.0/docs/versions.md#version-status-changes" target="_blank">
                  Source Control Versions
                </a> section
              </li>
            </ul>
          </div>
        </div>
        <ProductStatus role="cna" :productStatusList="cveFieldList.productsStatus.cna"></ProductStatus>
      </div>
      <div id="cve-credits" class="content" v-if="cveFieldList.credits.length > 0">
        <h3 class="title is-size-5">Credits</h3>
        <ul>
          <li v-for="(credit, index) in cveFieldList.credits" :key="`${credit}-${index}`">
            {{credit.value}}
            <span class="tag ml-2" v-if="typeof credit.type !== 'undefined' && credit.type.length > 0">{{credit.type}}</span>
          </li>
        </ul>
      </div>
      <div id="cve-references" class="content" v-if="cveFieldList.references.length > 0">
        <h3 class="title is-size-5">References</h3>
        <ul>
          <li v-for="(reference, index) in cveFieldList.references" :key="`link-${index}`" class="cve-word-wrap">
            <span class="icon-text">
              <a :href="reference.url" target="_blank">
                {{ (typeof reference.name !== 'undefined' && reference.name.length > 0) ? `${reference.hostname}: ${reference.name}` : reference.url }}
                <span class="icon cve-icon-xxs">
                  <p id="enewsletter" class="is-hidden">external site</p>
                  <font-awesome-icon icon="external-link-alt" aria-labelledby="enewsletter"></font-awesome-icon>
                </span>
              </a>
            </span>
            <span v-for="tag in reference.tags" :key="tag">
              <span class="tag ml-2" v-if="tag.length > 0">{{tag}}</span>
            </span>
          </li>
        </ul>
      </div>
      <div id="cve-nvd-link">
        <span>View additional information about
          <a :href="`${NVDBaseUrl}${useCveRecordLookupStore.cveId}`" target='_blank'>
            {{ useCveRecordLookupStore.recordData.cveMetadata.cveId }}
            <span class='icon cve-icon-xxs'>
              <p id='nvd' class='is-hidden'>external site</p>
              <font-awesome-icon icon='external-link-alt' aria-labelledby='nvd'></font-awesome-icon>
            </span>
          </a>
          on NVD.
        </span>
        <p class='cve-help-text'>(Note: The NVD is not operated by the CVE Program)</p>
      </div>
    </div>
    <div v-if="roleTabs['ADP']" id="cve-tab-adp">
      <div class="cve-adp-containers" v-for="adpContainer in adpContainers" :key="adpContainer.key">
        <CvssCwe :containerObject="adpContainer">
          <h3 class="title">{{ adpContainer.providerMetadata.shortName }}</h3>
        </CvssCwe>
        <div v-for="(adpContainer) in cveFieldList.productsStatus.adp" :key="adpContainer.key"
          class="mt-5"
        >
          <h4 class="title is-size-5">Product Status</h4>
          <ProductStatus role="adp" :productStatusList="adpContainer"></ProductStatus>
        </div>
      </div>
    </div>
  </div> 
</template>

<script>
import _ from 'lodash';
import axios from 'axios';
import CvssCwe from '@/components/CvssCwe.vue';
import ProductStatus from '@/components/ProductStatus.vue';
import { useCveRecordLookupStore } from '@/stores/cveRecordLookup.ts';

export default {
  name: 'PublishedRecord',
  components: {
    CvssCwe,
    ProductStatus,
  },
  props: {
    NVDBaseUrl: {
      type: String,
      required: true,
    },
    cvenavs: {
      type: Object,
      required: true,
    },
  },
  data() {
    return {
      isMessageExpanded: false,
      isHelpTestShown: false,
      cveRecordFields: ['ID', 'CNA', 'Credits', 'Description', 'References', 'State', 'Tags', 'Title', 'VendorsProductsVersions',
        'RecordPublishedDate', 'RecordUpdatedDate'],
      cveFieldList: {
        cveId: '',
        credits: [],
        descriptions: [],
        productsStatus: {
          cna: [],
          adp: {}
        },
        title: '',
        state: '',
        assigner: '',
        dateUpdatedCveMetadata: '',
        datePublishedCveMetadata: '',
        references: [],
        tags: [],
      },
      originalRecordData: useCveRecordLookupStore().recordData || {},
      cveServicesBaseUrl: import.meta.env.VITE_CVE_SERVICES_BASE_URL,
      useCveRecordLookupStore: useCveRecordLookupStore(),
      cpe: {},
      cnaContainer: {},
      adpContainers: {},
      roleTabs: {}
    };
  },
  methods: {
    toggleRoleTab(roleName){
      Object.keys(this.roleTabs).forEach( (role) => {
        if (role === roleName) {
          this.roleTabs[roleName] = true;
        } else {
          this.roleTabs[role] = false;
        }
      });
    },
    populateRoleTabs() {
      this.roleTabs['CNA'] = true;
      let adpContainerExists = Object.keys(this.adpContainers).length > 0 ? true : false;
      if (adpContainerExists) {
        if (useCveRecordLookupStore().hasAdpInfo) {
          this.roleTabs['ADP'] = false;
        }
      }
    },
    getContainers() {
      this.cnaContainer = this.originalRecordData.containers.cna;
      if (this.originalRecordData?.containers?.adp) {
        this.originalRecordData.containers.adp.forEach((adp) => {
        this.adpContainers[adp.providerMetadata.shortName] = adp;
      });
      }
    },
    initializeFields() {
      this.cveRecordFields.forEach((field) => {
        this.getContentForField(field);
      });
    },
    getCNA() {
      const assignerShortName = this.originalRecordData?.cveMetadata?.assignerShortName;
      const partnerUUID = this.originalRecordData?.cveMetadata?.assignerOrgId;

      if (this.hasData(assignerShortName)) {
        const url = `${import.meta.env.VITE_API_BASE_URL}cve-partner-name-map.json`;
        axios
          .get(url, { timeout: 30000 })
          .then((response) => {
            const shortLongNameMap = response.data;
            if (shortLongNameMap?.[partnerUUID]) {
              this.cveFieldList.assigner = shortLongNameMap?.[partnerUUID];
            }
          })
          .finally(() => {
            if (this.cveFieldList.assigner.length === 0) {
              this.cveFieldList.assigner = assignerShortName.replace('_', ' ');
            }
          });
      }
    },
    getCredits() {
      // schema: https://github.com/CVEProject/cve-schema/blob/master/schema/v5.0/CVE_JSON_5.0_schema.json#L971-L1015
      const value = this.originalRecordData.containers?.cna?.credits;
      if (this.hasData(value)) {
        value.forEach((credit) => {
          if (this.isEnglishLanguage(credit.lang)) {
            this.cveFieldList.credits.push(credit);
          }
        });
      }
    },
    getRecordPublishedDate() {
      const value = this.originalRecordData.cveMetadata?.datePublished;
      if (this.hasData(value)) {
        this.cveFieldList.datePublishedCveMetadata = this.getDate(value);
      }
    },
    getRecordUpdatedDate() {
      const value = this.originalRecordData.cveMetadata?.dateUpdated;
      if (this.hasData(value)) {
        this.cveFieldList.dateUpdatedCveMetadata = this.getDate(value);
      }
    },
    getCVEid() {
      const value = this.originalRecordData.cveMetadata?.cveId;
      if (this.hasData(value)) {
        this.cveFieldList.cveId = value;
      } else {
        this.cveFieldList.cveId = useCveRecordLookupStore().recordData.cveMetadata.cveId; // user-provided CVE ID
      }
    },
    getDescription() {
      const value = this.originalRecordData.containers?.cna?.descriptions;
      if (this.hasData(value)) {
        value.forEach((desc) => {
          if (this.isEnglishLanguage(desc.lang)) {
            this.cveFieldList.descriptions.push(desc.value);
          }
        });
      }
    },
    getReferences() {
      const value = this.originalRecordData.containers?.cna?.references;
      if (this.hasData(value)) {
        const filteredReferences = [];
        const regex = /^x_refsource/;

        value.forEach((reference) => {
          let newReference = {};
          const filteredTags = [];

          if (reference?.tags) {
            reference.tags.forEach((tag) => {
              if (!regex.test(tag)) filteredTags.push(tag);
            });
          }
          newReference = _.cloneDeep(reference);
          newReference.tags = filteredTags;
          if (newReference?.name && newReference.name.length > 0) newReference.hostname = (new URL(newReference.url)).hostname.replace('www.', '');
          filteredReferences.push(newReference);
        });

        this.cveFieldList.references = filteredReferences;
      }
    },
    getState() {
      const value = this.originalRecordData.cveMetadata?.state;
      if (this.hasData(value)) {
        this.cveFieldList.state = value;
      }
    },
    getTags() {
      const value = this.originalRecordData.containers?.cna?.tags;
      if (this.hasData(value)) {
        this.cveFieldList.tags = value;
      }
    },
    getTitle() {
      const value = this.originalRecordData.containers?.cna?.title;
      if (this.hasData(value)) {
        this.cveFieldList.title = value;
      }
    },
    // getProductsStatus() is adapted from https://github.com/Vulnogram/seaview/blob/main/script.js#L140-L253
    getProductsStatus(containerName, containerAffectedList) {
      const affectedList = containerAffectedList;
      if (this.hasData(affectedList)) {
        const prodStatusTemplate = {
          vendor: '',
          product: '',
          platforms: [],
          cpes: [],
          defaultStatus: '',
          versionsColumns: [],
        };

        /**
          Building the Product Status table each product in containers.cna.affected[]:
          - column 1: vendor, product, platforms, cpes
          - column 2: affected/unaffected/unknown list(s)/subcomlumn(s)
        */
        affectedList.forEach((affectedObj) => {
          const prodStatus = _.cloneDeep(prodStatusTemplate);
          // Building column 1
          if (this.hasData(affectedObj?.vendor)) prodStatus.vendor = affectedObj.vendor;
          if (this.hasData(affectedObj?.product)) prodStatus.product = affectedObj.product;
          if (this.hasData(affectedObj?.platforms)) prodStatus.platforms = _.cloneDeep(affectedObj.platforms);
          if (this.hasData(affectedObj?.cpes)) { 
            prodStatus.cpes = affectedObj.cpes;
            if(containerName.toLowerCase() !== 'cna') {
              useCveRecordLookupStore().hasAdpInfo = true;
            }
          }

          // Building column 2: an affected/unaffected/unknown subcolumn(s) for each product version in containers.cna.affected[i].versions[].
          const versionsColumns = [];
          // https://github.com/Vulnogram/seaview/blob/main/script.js#L175-L216
          if (this.hasData(affectedObj?.versions)) {
            const tableRowTemplate = {
              versionRange: {
                parentVersion: [],
                parentVersionRange: [],
                parentVersionStatus: '',
                versionsChanges: [],
              },
            };

            affectedObj.versions.forEach((versionObj) => {
              const tableRow = _.cloneDeep(tableRowTemplate);
              const versionsAndChangesTemplate = {
                versions: [],
                changes: [],
                changeColorList: [],
              };
              const productVersion = `${versionObj?.version || '(no version provided)'}`;
              const versionStatus = versionObj?.status || 'noVersionStatus'; // affected, unaffected, OR unknown

              if (this.hasData(versionObj?.changes)) {
                let range = [];

                if (productVersion !== 'unspecified' && productVersion !== 0) {
                  range.push('from');
                  range.push(productVersion);
                }

                if (versionObj?.lessThan) {
                  let rangeEnd = ['before', `${versionObj?.lessThan || '(no lessThan version provided)'}`];
                  if (this.isUnspecifiedOrWildCard(versionObj, 'lessThan')) rangeEnd = [];
                  if ((rangeEnd.length > 0) && (versionObj.lessThan !== productVersion)) {
                    range = range.concat(rangeEnd);
                  }
                } else if (versionObj?.lessThanOrEqual) {
                  let rangeEnd = ['through', `${versionObj?.lessThanOrEqual || '(no lessThan version provided)'}`];
                  if (this.isUnspecifiedOrWildCard(versionObj, 'lessThanOrEqual')) rangeEnd = '';
                  if ((rangeEnd.length > 0) && (versionObj.lessThanOrEqual !== productVersion)) {
                    range = range.concat(rangeEnd);
                  }
                } else {
                  range = [productVersion];
                }

                // save the version changes
                const versionsAndChangesCopy = _.cloneDeep(versionsAndChangesTemplate);

                // Build a temp 'changes' object by going through container.cna.affected[x].versions[x].changes[]
                //   and categorize by 'status' (affected, unaffected, or unknown)
                //   which can be different from the main 'status' (container.cna.affected[x].versions[x].status).
                versionObj.changes.forEach((change) => {
                  versionsAndChangesCopy.changeColorList.push([change.status, 'from', change.at]);
                });

                tableRow.versionRange.parentVersionStatus = versionStatus;
                tableRow.versionRange.parentVersion = ['from', productVersion];
                tableRow.versionRange.parentVersionRange = range;
                tableRow.versionRange.versionsChanges = versionsAndChangesCopy.changeColorList;
              } else {
                let rangeStart = [];
                if (productVersion !== 'unspecified' && productVersion !== '*') rangeStart = ['from', productVersion];

                tableRow.versionRange.parentVersion = [productVersion];
                if (this.hasData(versionObj?.lessThan)) {
                  let range = [];
                  let rangeEnd = ['before', `${versionObj?.lessThan || '(no version.lessThan provided)'}`];
                  if (this.isUnspecifiedOrWildCard(versionObj, 'lessThan')) rangeEnd = [];
                  if (rangeEnd.length > 0) {
                    range = range.concat(rangeStart, rangeEnd);
                  } else {
                    range = rangeStart;
                  }
                  tableRow.versionRange.parentVersionStatus = versionStatus;
                  tableRow.versionRange.parentVersionRange = range;
                } else if (this.hasData(versionObj?.lessThanOrEqual)) {
                  let range = [];
                  let rangeEnd = ['through', `${versionObj?.lessThanOrEqual || '(no version.lessThan provided)'}`];
                  if (this.isUnspecifiedOrWildCard(versionObj, 'lessThanOrEqual')) rangeEnd = [];
                  range = range.concat(rangeStart, rangeEnd);
                  tableRow.versionRange.parentVersionStatus = versionStatus;
                  tableRow.versionRange.parentVersionRange = range;
                } else {
                  tableRow.versionRange.parentVersionStatus = versionStatus;
                  tableRow.versionRange.parentVersion = ['at', productVersion];
                  tableRow.versionRange.parentVersionRange = ['at', productVersion];
                }
              }
              versionsColumns.push(tableRow.versionRange);
            });

            if (this.hasData(affectedObj?.defaultStatus)) {
              prodStatus.defaultStatus = `${affectedObj.defaultStatus}`;
            }
          } else {
            prodStatus.defaultStatus = this.hasData(affectedObj?.defaultStatus) ? `All versions are ${affectedObj.defaultStatus}` : '';
          }
          prodStatus.versionsColumns = this.create2DTable(versionsColumns);
          if (containerName === 'cna') {
            this.cveFieldList.productsStatus[containerName].push(_.cloneDeep(prodStatus));
          } else {
            this.cveFieldList.productsStatus.adp[containerName] = [];
            this.cveFieldList.productsStatus.adp[containerName].push(_.cloneDeep(prodStatus));
          }
          
        });
      }
    },
    getContentForField(field) {
      switch (field) {
        case 'CNA':
          this.getCNA();
          break;
        case 'Credits':
          this.getCredits();
          break;
        case 'Description':
          this.getDescription();
          break;
        case 'ID':
          this.getCVEid();
          break;
        case 'RecordPublishedDate':
          this.getRecordPublishedDate();
          break;
        case 'RecordUpdatedDate':
          this.getRecordUpdatedDate();
          break;
        case 'References':
          this.getReferences();
          break;
        case 'State':
          this.getState();
          break;
        case 'Tags':
          this.getTags();
          break;
        case 'Title':
          this.getTitle();
          break;
        case 'VendorsProductsVersions':
          if (this.originalRecordData.containers?.cna?.affected) this.getProductsStatus('cna', this.originalRecordData.containers.cna.affected);
          if (this.originalRecordData.containers?.adp) {
            this.originalRecordData.containers.adp.forEach( (adpContainer) => {
              this.getProductsStatus(adpContainer.providerMetadata.shortName, adpContainer?.affected);
            });
          }
          break;
        default:
          break;
      }
    },
    hasData(value) {
      if (typeof value !== 'undefined' && value.length > 0) {
        return true;
      }

      return false;
    },
    isEnglishLanguage(lang) {
      const regex = /^(en)/;
      const isEnglishLanguage = regex.test(lang);

      return isEnglishLanguage;
    },
    isUnspecifiedOrWildCard(field, key) {
      return (field[key] === 'unspecified' || field[key] === '*');
    },
    getDate(dateTime) {
      const [date] = dateTime.split('T');
      return date;
    },
    toggleRecord() {
      useCveRecordLookupStore().showJsonRecord = !useCveRecordLookupStore().showJsonRecord;
    },
    create2DTable(affectedUnaffectedUnknownTable) {
      const tableWithHeaders = {
        headers: [],
        twoDTable: {},
      };

      // Build table headers: affected, and/or unaffected, and/or unknown
      affectedUnaffectedUnknownTable.forEach((row) => {
        if (tableWithHeaders.headers.indexOf(row.parentVersionStatus) < 0) tableWithHeaders.headers.push(row.parentVersionStatus);
      });
      tableWithHeaders.headers.sort();

      // Build 2D table w/ 'version'&'changes' or '' for table cell w/ no value
      affectedUnaffectedUnknownTable.forEach((row) => {
        // for each row fill in 'version'&'changes' or ''
        if (Object.prototype.hasOwnProperty.call(tableWithHeaders.twoDTable, row.parentVersionStatus)) {
          tableWithHeaders.twoDTable[row.parentVersionStatus].push(row);
        } else {
          tableWithHeaders.twoDTable[row.parentVersionStatus] = [row];
        }
      });
      return tableWithHeaders;
    }
  },
  beforeMount() {
    this.initializeFields();
    this.getContainers();
    this.populateRoleTabs();
  },
};
</script>

<style lang="scss" scoped>
@import '@/assets/style/globals.scss';
@import '@/assets/style/cveRecord.scss';
@import '@/assets/style/elements/cveTableStacked.scss';

.columns {
  margin-top: 0rem !important;
}

.columns:not(:last-child) {
    margin-bottom: 0.5rem !important;
}

.cve-row {
  margin-left: unset !important;
  margin-right: unset !important;
}

.cve-versions-columns {
  padding-left: 4px !important;
}
.cve-versions-column:not(:last-child) {
  @include from($desktop) {
    border-right: $theme-color-base-light solid 2px;
  }

  @include until($tablet) {
    border-bottom: $theme-color-base-light solid 2px;
  }
}

td {
  width: 33% !important;
}

.cve-light-gray-table-header {
  text-transform: capitalize;
  background-color: $theme-color-base !important;
  border: 1px solid #F0F0F0 !important;
}

.cve-border-light-gray {
  border: 1px solid #F0F0F0;
}

.menu-list {
  margin-left: 1.5rem !important;
  margin-right: 0.25rem !important;
}

.cve-tag {
  background-color: $theme-color-violet-vivid-60 !important;
  color: white !important;
  font-weight: 600;
}

.cve-state-tag {
  background-color: $theme-color-blue-warm-20 !important;
  color: $theme-color-base-darkest !important;
}

.cve-tab {
  border: none;
  background: unset;
}
.cve-tab-active {
  font-weight: 700;
  border-top: none;
  border-right: none;
  border-left: none;
  border-bottom-left-radius: unset !important;
  border-bottom-right-radius: unset !important;
  border-bottom: 2px solid $theme-color-accent-warm ;
}
</style>
