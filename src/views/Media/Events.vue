<template>
  <div id="cve-secondary-page-main-container">
    <div class="columns is-centered">
      <div class="column is-12-desktop is-11-tablet cve-main-column-content-width">
        <main id="cve-main-page-content" role="main">
          <h1 class="title">Events</h1>
          <div class="content" v-for="category in [{label: 'upcoming'},{label: 'past'}]" :key="category.label">
            <h2 class="title is-capitalized">{{category.label}}</h2>
            <div v-if="category.label == 'upcoming'">
            <div class="content"  v-for="(eventType, index) in sortEvents[category.label]"  :key="index">
              <p class="subtitle is-size-4">{{eventType[0].date.repeat ? 'Recurring' : ''}}</p>
              <table class="table cve-border-dark-blue is-striped is-hoverable">
                <thead>
                  <th style="width: 20%">Date</th>
                  <th style="width: 30%">Event</th>
                  <th style="width: 40%">Description</th>
                  <th>Access</th>
                </thead>
                <tbody>
                  <tr v-for="event in eventType"  :key="event.id">
                    <td style="width: 20%" class="is-capitalized">
                      <span v-if="event.date.repeat">
                        {{event.date.repeat.recurrence == 'biweekly' ? 'Every other ' : 'Every'}} {{event.date.repeat.day}}
                      </span>
                      <span class="is-capitalized" v-else>
                        {{formatDate(event.date.start)}} {{(event.date.start !== event.date.end) ? '— ' + formatDate(event.date.end) : ''}}
                      </span>
                    </td>
                    <td style="width: 30%" class="is-capitalized">
                      <span v-if="event.url != '' ">
                        <a :href="$sanitize(event.url)">{{event.title}}</a>
                      </span>
                      <span v-else>
                        {{event.title}}
                      </span>
                    </td>
                    <td style="width: 40%">{{event.description}}</td>
                    <td class="is-capitalized">{{event.permission}}</td>
                  </tr>
                </tbody>
              </table>
            </div>
            </div>
            <div v-else>
              <table class="table cve-border-dark-blue is-striped is-hoverable">
                <thead>
                  <th style="width: 20%">Date</th>
                  <th style="width: 30%">Event</th>
                  <th style="width: 40%">Description</th>
                  <th>Access</th>
                </thead>
                <tbody class="is-capitalized">
                  <tr v-for="event in sortEvents[category.label]"  :key="event.id">
                    <td style="width: 20%">
                      <span class="is-capitalized" v-if="event.date.repeat">
                        {{event.date.repeat.recurrence == 'biweekly' ? 'Every other ' : 'Every'}} {{event.date.repeat.day}}
                      </span>
                      <span class="is-capitalized" v-else>
                        {{formatDate(event.date.start)}} {{(event.date.start !== event.date.end) ? '— ' + formatDate(event.date.end) : ''}}
                      </span>
                    </td>
                    <td style="width: 30%" class="is-capitalized">
                      <span v-if="event.url != '' ">
                        <a :href="$sanitize(event.url)">{{event.title}}</a>
                      </span>
                      <span v-else>
                        {{event.title}}
                      </span>
                    </td>
                    <td style="width: 40%">{{event.description}}</td>
                    <td class="is-capitalized">{{event.permission}}</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </main>
      </div>
    </div>
  </div>
</template>

<script>
import eventsData from '../../assets/data/events.json';

export default {
  name: 'Events',
  data() {
    return {
      eventsList: eventsData,
    };
  },
  computed: {
    sortEvents() {
      const sortedEventsList = {
        upcoming: {
          other: [],
          recurring: [],
        },
        past: [],
      };
      const recurringEvents = [];
      const otherEvents = [];

      const today = new Date();

      this.eventsList.forEach((event) => {
        if (this.isUpcomingEvent(event.date, today)) {
          if (event.date.repeat) {
            recurringEvents.push(event);
          } else if (this.isUpcomingEvent(event.date, today)) {
            otherEvents.push(event);
          }
        } else {
          sortedEventsList.past.push(event);
        }
      });

      sortedEventsList.upcoming.recurring = this.sortReccuringEvents(recurringEvents);
      sortedEventsList.upcoming.other = this.sortDate(otherEvents);

      return sortedEventsList;
    },
  },
  methods: {
    isUpcomingEvent(eventDate, today) {
      let isUpcoming = false;
      const eventStart = eventDate.start.length > 0 ? eventDate.start.split('-') : today;
      const eventEnd = eventDate.end.length > 0 ? eventDate.end.split('-') : today;
      const eventStartDate = new Date(eventStart[0], eventStart[1] - 1, eventStart[2]);
      const eventEndDate = new Date(eventEnd[0], eventEnd[1] - 1, eventEnd[2]);
      if ((eventStartDate > today) || (eventEndDate > today)) isUpcoming = true;
      return isUpcoming;
    },
    formatDate(newsDate) {
      const yyyymmdd = newsDate.split('-');
      const formattedDate = new Date();
      formattedDate.setFullYear(parseInt(yyyymmdd[0], 10));
      formattedDate.setMonth(parseInt(yyyymmdd[1] - 1, 10));
      formattedDate.setDate(parseInt(yyyymmdd[2], 10));
      const options = { year: 'numeric', month: 'long', day: 'numeric' };
      return formattedDate.toLocaleDateString(undefined, options);
    },
    sortDate(dates) {
      const sortedEvents = dates.sort((a, b) => {
        const date1 = new Date(a.date.start);
        const date2 = new Date(b.date.start);
        return date1 - date2;
      });

      return sortedEvents;
    },
    sortReccuringEvents(dates) {
      const days = {
        sunday: 0,
        monday: 1,
        tuesday: 2,
        wednesday: 3,
        thursday: 4,
        friday: 5,
        saturday: 6,
      };

      const today = new Date();
      let todayOrAfter = [];
      let beforeToday = [];

      dates.forEach((event) => {
        if (days[event.date.repeat.day.toLowerCase()] > today.getDay()) {
          todayOrAfter.push(event);
        } else {
          beforeToday.push(event);
        }
      });

      todayOrAfter.sort((a, b) => days[a.date.repeat.day.toLowerCase()] - days[[b.date.repeat.day.toLowerCase()]]);

      beforeToday.sort((a, b) => days[a.date.repeat.day.toLowerCase()] - days[[b.date.repeat.day.toLowerCase()]]);

      return todayOrAfter.concat(beforeToday);
    },
  },
};
</script>

<!-- Add "scoped" attribute to limit CSS to this component only -->
<style scoped lang="scss">
@import '../../assets/style/globals.scss';

</style>
