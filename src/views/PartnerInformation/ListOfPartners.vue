<template>
  <div id="cve-secondary-page-main-container">
    <div class="columns is-centered">
      <div class="column is-2 mt-3">
        <div class="content menu">
          <form>
            <fieldset class="control">
              <legend><h3 class="title">Sort By</h3></legend>
              <label class="radio">
                <input type="radio" name="partner" v-model="sortBy" v-bind:value='{field: "organizationName", direction: "asc"}'/>
                Partner (asc)
              </label>
              <label class="radio">
                <input type="radio" name="partner" v-model="sortBy" v-bind:value='{field: "organizationName", direction: "desc"}' checked/>
                Partner (desc)
              </label>
            </fieldset>
          </form>
        </div>
      </div>
      <div class="column is-6">
        <main id="cve-main-page-content" role="main">
          <h1 class="title">List of Partners</h1>
          <div class="content">
	    <p>
	      Each <router-link to="/ProgramOrganization/CNAs">CVE Numbering Authority (CNA)</router-link> partner listed
	      below assigns CVE IDs per a specific
	      <router-link to="/About/Glossary?activeTerm=glossaryScope">scope</router-link>. 
	    <p>
 	    <p class="has-text-weight-bold">
	      To report a vulnerability/request a CVE ID: 
	    </p>
 	    <ol>
	      <li>Locate correct CNA via organization name, CNA type, or scope and click “View More.”</li>
	      <li>Read CNA’s disclosure policy.</li>
	      <li>Contact CNA using its specified contact method.</li>
	    </ol>
 	    <p>
              View the <router-link to="/About/Process">CVE process</router-link> page.
	    </p>
            <p> <!-- prog role descriptions -->
 	      <span class="has-text-weight-bold">Description of Program Roles</span>
	        <b-collapse animation="slide" :open="isOpen == index" @open="isOpen = index">
		   <template #trigger="props">
		      <div class="cve-accordion-icon" role="button">
			<b-icon
			  pack="fas"
			  size="is-small"
			  :icon="props.open ? 'minus' : 'plus'">
			</b-icon>
                      </div>
                   </template>
                   <ul>
                     <li class="pb-2" v-for="cnaRoles in partners.roles" :key="cnaRoles.term">
                       <span class="has-text-weight-bold">{{cnaRoles.term}}:</span> <span v-html="cnaRoles.definition"/>
                     </li>
                   </ul>
              </b-collapse>
            </p>
            <p> <!-- org type descriptions -->
 	      <span class="has-text-weight-bold">Description of Organization Types</span>
	        <b-collapse animation="slide" :open="isOpen == index" @open="isOpen = index">
		   <template #trigger="props">
		      <div class="cve-accordion-icon" id="orgTypes" role="button">
		        <b-icon
			  pack="fas"
			  size="is-small"			    
			  :icon="props.open ? 'minus' : 'plus'">
			</b-icon>
                      </div>
                   </template>
                   <ul>
                     <li class="pb-2" v-for="org in partners.orgType" :key="org.id">
                       <span class="has-text-weight-bold">{{org.term}}:</span> <span v-html="org.definition"/>
                     </li>
                   </ul>
              </b-collapse>
            </p>
          </div><!-- end content -->
            <h2 class="title">Search</h2>
            <div class="field has-addons is-grouped-right">
              <div class="control is-expanded has-icons-right">
                <input v-model="searchTerms" class="input cve-search-input" type="text" placeholder="Enter search terms" @keyup.enter="search">
              </div>
              <div class="field is-grouped is-grouped-right">
                <button class="button cve-button-accent-warm" :class="{'is-loading': isSearching}" @click="search">
                  <span class="icon is-small is-left">
                    <font-awesome-icon icon="search" />
                  </span>
                </button>
                <button class="button is-light control" :class="{'is-loading': isSearching}" @click="clearSearch" v-show="searchTerms.length > 0">
                  <span class="icon is-small is-left">
                    <font-awesome-icon icon="times" />
                  </span>
                </button>
              </div> 
          </div> <!-- end search field groups -->

          <div class="table-container" v-show="!emptySearchResults">
            <table class="table is-bordered is-striped is-hoverable">
              <thead>
                <tr>
                    <th scope="col">Partner</th>
                    <th scope="col">Scope</th>
                    <th scope="col">
                      Program Role 
                    </th>
                    <th scope="col">
                      Organization Type 
                    </th>
                </tr>
              </thead>
              <tbody>
                <tr v-for="(CNA, index) in pagination.currentCNAstoDisplay" :key="index">
                  <td scope="row" data-label="Partner">
                    <router-link :to="'/PartnerInformation/ListOfPartners/partner/'+CNA.shortName"> {{CNA.organizationName}}</router-link>
                  </td>
                  <td data-label="Scope" v-html="CNA.scope"></td>
                  <td data-label="Program Role*">{{CNA.CNA.role.join(', ')}}</td>
                  <td data-label="Organization Type*">{{CNA.CNA.type.join(', ')}}</td>
                </tr>
              </tbody>
            </table>
            <nav class="pagination is-centered" aria-label="pagination">
              <button class="button cve-button cve-button-outline" v-bind:disabled="pagination.currentPage > 1 ? false : true"
                @click=getPreviousPage><font-awesome-icon icon="angle-left" /></button>
              <button class ="pagination-next button cve-button cve-button-outline"
                v-bind:disabled="pagination.currentPage >= pagination.totalPages ? true : false"
                @click=getNextPage><font-awesome-icon icon="angle-right" /></button>
              <ul class ="pagination-list" >
                <li v-for="(pageNumber, index) in pagination.pages" :key="index">
                  <a v-bind:class="pageNumber == pagination.currentPage ? 'pagination-link cve-button cve-button-outline is-current' :
                    'pagination-link cve-button cve-button-outline'" @click=updatePagination(pageNumber)
                    v-bind:aria-label="'Goto page ' + pageNumber"
                    v-bind:aria-current="(pageNumber == pagination.currentPage) ? 'page' : false">{{pageNumber}}</a>
                </li>
              </ul>
            </nav>
          </div>
              <p class="has-text-centered is-size-5" v-show="emptySearchResults">
                No results found for <span class="has-text-weight-bold">{{searchTerms}}</span>
              </p>
        </main>
      </div>
    </div>
  </div>
</template>

<script>
import CNAData from '@/assets/data/CNAsList.json';
import GlossaryData from '../../assets/data/glossaryEntries.json';
import Vue from 'vue';

export default {
  name: 'ListOfParners',
  props: {
    cvenavs: {
      type: Object,
      required: true,
    },
  },
  data() {
    return {
      isOpen: -1,    
      CNAsList: CNAData,
      searchTerms: '',
      isSearching: false,
      emptySearchResults: false,
      filters: {
        organizationName: true,
        scope: true,
        role: true,
        type: true,
      },
      sortBy: {
        field: 'organizationName',
        direction: 'asc',
      },
      pagination: {
        totalItems: 0,
        currentPage: 1,
        pageSize: 10,
        totalPages: 0,
        startIndex: 0,
        endIndex: 0,
        maxPages: 17,
        pages: [],
        currentCNAstoDisplay: [],
      },
      partners: {
        roles: [],
        orgType: [
          {
            id: 1,
            term: 'Bug Bounty Programs',
            definition: 'Assigns CVE IDs to products and projects that utilize the Bug Bounty service’s product offerings.',
          },
          {
            id: 2,
            term: 'Hosted Services',
            definition: 'Assigns CVE IDs for vulnerabilities found in their own services.',
          },
          {
            id: 3,
            term: 'National and Industry CERTs',
            definition: 'Performs incident response and vulnerability disclosure services for nations or industries/. '
              + 'They may assign CVE IDs as part of their role and scope.',
          },
          {
            id: 4,
            term: 'Vendors and Projects',
            definition: 'Assigns CVE IDs for vulnerabilities found in their own products and projects.',
          },
          {
            id: 5,
            term: 'Vulnerability Researchers',
            definition: 'Assigns CVE IDs to products and projects upon which they perform vulnerability analysis.',
          },
        ],
      },
      isPartnerRoleVisible: false,
      isParterOrgType: false,
      isFocus: false,
    };
  },
  created() {
    this.sortedCNAs();
    this.paginate();
    this.getPartnerRolesDefinition();
  },
  watch: {
    sortBy() {
      this.sortedCNAs();
    },
  },
  computed: {
    totalPages() {
      return Math.ceil(this.CNAsList.length / this.pagination.pageSize);
    },
  },
  methods: {
    search() {
      this.isSearching = true;

      const splitTermsList = this.searchTerms.split(' ').filter((term) => term.length > 0);

      const regexExp = new RegExp(splitTermsList.join('|'), 'gi');
      this.CNAsList = CNAData.filter((partner) => (partner.organizationName.toLowerCase().match(regexExp)
        || partner.scope.toLowerCase().match(regexExp) || this.isSearchTermFound(partner.CNA.role, regexExp)
        || this.isSearchTermFound(partner.CNA.type, regexExp)));

      if (this.CNAsList.length > 0) {
        this.sortedCNAs();
        this.emptySearchResults = false;
      } else {
        this.emptySearchResults = true;
      }

      this.isSearching = false;
    },
    isSearchTermFound(list, regexExp) {
      let found = false;
      list.forEach((element) => {
        if (element.toLowerCase().match(regexExp)) found = true;
      });

      return found;
    },
    clearSearch() {
      this.searchTerms = '';
    },
    sortedCNAs() {
      const sortModifier = (this.sortBy.direction === 'asc') ? 1 : -1;
      this.CNAsList.sort((CNA1, CNA2) => {
        const upperCasedValue1 = CNA1[this.sortBy.field].toUpperCase();
        const upperCasedValue2 = CNA2[this.sortBy.field].toUpperCase();
        if (upperCasedValue1 < upperCasedValue2) {
          return -1 * sortModifier;
        }
        if (upperCasedValue1 > upperCasedValue2) {
          return 1 * sortModifier;
        }
        return 0;
      });

      this.paginate();
    },
    paginate() {
      // calculate total pages
      this.pagination.totalItems = this.CNAsList.length;
      const totalPages = Math.ceil(this.pagination.totalItems / this.pagination.pageSize);

      // ensure current page isn't out of range
      if (this.pagination.currentPage < 1) {
        this.pagination.currentPage = 1;
      } else if (this.pagination.currentPage > totalPages) {
        this.pagination.currentPage = totalPages;
      }

      let startPage; let
        endPage;
      if (totalPages <= this.pagination.maxPages) {
        // total pages less than max so show all pages
        startPage = 1;
        endPage = totalPages;
      } else {
        // total pages more than max so calculate start and end pages
        const maxPagesBeforeCurrentPage = Math.floor(this.pagination.maxPages / 2);
        const maxPagesAfterCurrentPage = Math.ceil(this.pagination.maxPages / 2) - 1;
        if (this.pagination.currentPage <= maxPagesBeforeCurrentPage) {
          // current page near the start
          startPage = 1;
          endPage = this.pagination.maxPages;
        } else if (this.pagination.currentPage + maxPagesAfterCurrentPage >= totalPages) {
          // current page near the end
          startPage = totalPages - this.pagination.maxPages + 1;
          endPage = totalPages;
        } else {
          // current page somewhere in the middle
          startPage = this.pagination.currentPage - maxPagesBeforeCurrentPage;
          endPage = this.pagination.currentPage + maxPagesAfterCurrentPage;
        }
      }

      // calculate start and end item indexes
      this.pagination.startIndex = (this.pagination.currentPage - 1) * this.pagination.pageSize;
      this.pagination.endIndex = Math.min(this.pagination.startIndex + this.pagination.pageSize - 1, this.pagination.totalItems - 1);

      // create an array of pages to loop through in the pager control
      this.pagination.pages = Array.from(Array((endPage + 1) - startPage).keys()).map((i) => startPage + i);
      this.pagination.totalPages = totalPages;

      this.pagination.currentCNAstoDisplay = this.CNAsList.slice(this.pagination.startIndex, this.pagination.endIndex + 1);
    },
    updatePagination(pageNumber) {
      this.pagination.currentPage = pageNumber;
      this.paginate();
    },
    getPreviousPage() {
      this.pagination.currentPage -= 1;
      this.paginate();
    },
    getNextPage() {
      this.pagination.currentPage += 1;
      this.paginate();
    },
    getPartnerRolesDefinition() {
      const cnaRoles = ['CVE Numbering Authority (CNA)', 'CVE Numbering Authority of Last Resort (CNA-LR)', 'Root CNA',
        'Top-Level Root CNA (TLR-CNA)'];
      const htmlFilterRegex = /(<([^>]+)>)/ig;
      this.partners.roles = GlossaryData.filter((term) => {
        if (cnaRoles.includes(term.term)) {
          const termCopy = term;
          termCopy.definition = term.definition.replace(htmlFilterRegex, '');
          return termCopy;
        }
        return null;
      });
    },
    showAlert(partnerTableHeading) {
      if (partnerTableHeading === 'role') {
        this.isPartnerRoleVisible = !this.isPartnerRoleVisible;
      }

      if (partnerTableHeading === 'orgType') {
        this.isParterOrgType = !this.isParterOrgType;
      }
    },
  },
};
</script>

<style scoped lang="scss">
@import '../../assets/style/globals.scss';
@import '../../assets/style/elements/cveTableStacked.scss';

label {
    padding-right: 10px;
}

p button {
    padding-top: 0px;
    padding-bottom: 0px;
    height: 24px;
}

::v-deep .collapse-trigger {
  display: inline !important;
}

.collapse {
  display: inline;
  margin-left: 5px;
}
</style>
