import { defineStore } from 'pinia';
import PartnerData from '@/assets/data/CNAsList.json';

export const usePartnerStore = defineStore('partner', {
  state: () => { 
    return {
      partnerCounts: {},
      partnerShortLongNameMap: {}
    }
  },
  actions: {
    populatePartnerCounts () {
      const partnerCounts = {
        type: {}, role: {}, totalPartners: 0, countries: {}, countriesCount: 0,
      };
    
      PartnerData.forEach((partner) => {
        if (partner.CNA.roles.length > 0) {
          partner.CNA.roles.forEach((roleObj) => {
            if (roleObj.role.toLowerCase() !== 'secretariat') {
              if (Object.prototype.hasOwnProperty.call(partnerCounts.role, roleObj.role)) {
                partnerCounts.role[roleObj.role] += 1;
              } else {
                partnerCounts.role[roleObj.role] = 1;
              }
            }
          });
        }
    
        if (partner.CNA.type.length > 0) {
          partner.CNA.type.forEach((type) => {
            let newType = '';
            if (new RegExp(/^(Vulnerability Researcher)/, 'i').test(type)) { newType = 'Vulnerability Researcher(s)'; } else { newType = type; }
    
            if (newType.toLowerCase() !== 'n/a') {
              if (Object.prototype.hasOwnProperty.call(partnerCounts.type, newType)) {
                partnerCounts.type[newType] += 1;
              } else {
                partnerCounts.type[newType] = 1;
              }
            }
          });
        }
    
        if (Object.prototype.hasOwnProperty.call(partnerCounts.countries, partner.country)) {
          partnerCounts.countries[partner.country] += 1;
        } else {
          partnerCounts.countries[partner.country] = 1;
        }
      });
    
      partnerCounts.totalPartners = PartnerData.length;
      Object.keys(partnerCounts.countries).forEach((country)=>{
        if (country !== 'n/a') partnerCounts.countriesCount += 1;
      });

      partnerCounts.countries['No country affiliation'] = partnerCounts.countries['n/a'];
      delete partnerCounts.countries['n/a'];
    
      this.partnerCounts = partnerCounts;
    },
    async populatePartnerShortLongNameMap () {

      try {
        const url = `${import.meta.env.VITE_API_BASE_URL}cve-partner-name-map.json`;
        const respose = await axios.get(url, { timeout: 30000 });

        this.partnerShortLongNameMap = response?.data || {};
        
      } catch (error) {
        throw new Error(`Error fetching ${import.meta.env.VITE_API_BASE_URL}cve-partner-name-map.json`);
      }
    }
  }
});