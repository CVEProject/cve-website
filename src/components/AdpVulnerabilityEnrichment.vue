<template>
  <div id="cve-cvsss-cwes" class="mb-5">
    <div>
      <slot></slot>
      <p class="cve-help-text" v-if="roleName === 'adp'">
        SSVC, KEV, CVSS, and CWE data are shown below, if provided by the ADP. To view all fields and data for this record,
        select the
        <a id="cve-view-json" :href="`https://${cveServicesBaseUrl}/api/cve/${useCveRecordLookupStore.cveId}`" target="_blank">View JSON</a> link.
      </p>
      <p v-if="roleName === 'adp' && dateUpdated.length > 0">
        <span class="has-text-weight-semibold">Updated: </span>
        <time>{{dateUpdated}}</time>
      </p>
      <div id="cve-ssvcs" v-if="ssvcs.length > 0 && roleName === 'adp'" class="mt-5">
        <h4 class="title mb-0">SSVC</h4>
        <div class="cve-learn-more mb-5">
          <router-link to="/CVERecord/UserGuide/#cve-ssvc" class="cve-learn-more-link">Learn more</router-link>
        </div>
        <div class="cve-y-scroll">
          <div class="table-container cve-y-scroll" id="downloads-table">
            <table class="table is-striped is-hoverable cve-border-dark-blue cve-border-bottom-unset mt-0">
              <thead>
                <tr>
                  <th style="width: 20%">Exploitation</th>
                  <th style="width: 20%">Automatable</th>
                  <th style="width: 10%">Technical Impact</th>
                  <th style="width: 10%">Version</th>
                  <th style="width: 20%">Date Accessed</th>
                </tr>
              </thead>
              <tbody>
                <tr v-for="ssvc in ssvcs" :key="ssvc.key">
                  <td data-label="Exploitation" style="width: 20%">{{ ssvc.exploitation }}</td>
                  <td data-label="Automatable" style="width: 10%">{{ ssvc.automatable }}</td>
                  <td data-label="Technical Impact" style="width: 30%">{{ ssvc['technical impact'] }}</td>
                  <td data-label="Version" style="width: 10%">{{ ssvc.version }}</td>
                  <td data-label="Date Accessed" style="width: 30%">{{ ssvc.timestamp }}</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
      <div id="cve-kevs" v-if="kevs.length > 0 && roleName === 'adp'" class="mt-5">
        <h4 class="title mb-0">KEV</h4>
        <div class="cve-learn-more mb-5">
          <router-link to="/CVERecord/UserGuide/#cve-kev" class="cve-learn-more-link">Learn more</router-link>
        </div>
        <div class="cve-y-scroll">
          <ul class="mt-0">
            <li v-for="kev in kevs" :key="kev.key">
              <a :href="kev.reference" target="_blank">{{ kev.reference }}</a><span class="is-italic cve-help-text"> ({{ kev.dateAdded }})</span>
            </li>
          </ul>
        </div>
      </div>
      <div id="cve-cwes" v-if="cwes.length > 0" class="mt-5">
        <h4 class="title mb-0">CWE</h4>
        <div class="cve-learn-more mb-5">
          <router-link to="/CVERecord/UserGuide/#cve-cwe" class="cve-learn-more-link">Learn more</router-link>
        </div>
        <div class="cve-y-scroll">
          <ul class="mt-0">
            <li v-for="cwe in cwes" :key="cwe.key">
              <a v-if="cwe.cweId !== 'CWE ID not provided'" :href="`https://cwe.mitre.org/data/definitions/${cwe.cweNumber}.html`" target="_blank">
                <span class="has-text-weight-bold">{{ cwe.cweId }}<span v-if="cwe.description.length > 0">: </span></span>
                <span v-if="cwe.description.length > 0">{{ cwe.description }}</span>
              </a>
              <span v-else>
                <span>{{ cwe.description }}</span>
              </span>
            </li>
          </ul>
        </div>
      </div>
      <div id="cve-cvsss" v-if="cvsss.length > 0" class="mt-5 mb-5">
        <h4 class="title mb-0">CVSS</h4>
        <div class="cve-learn-more mb-5">
          <router-link to="/CVERecord/UserGuide/#cve-cvss" class="cve-learn-more-link">Learn more</router-link>
        </div>
        <div class="table-container cve-y-scroll" id="downloads-table">
          <table class="table is-striped is-hoverable cve-border-dark-blue cve-border-bottom-unset mt-0">
            <thead>
              <tr>
                <th style="width: 20%">Score</th>
                <th style="width: 20%">Severity</th>
                <th style="width: 20%">Version</th>
                <th>Vector String</th>
              </tr>
            </thead>
            <tbody>
              <tr v-for="cvss in cvsss" :key="cvss.key">
                <td data-label="Score" style="width: 20%">{{ cvss.baseScore }}</td>
                <td data-label="Severity" style="width: 20%">
                  <span :class="cvss.baseSeverityColorClass" class="tag has-text-weight-bold cve-state-tag">{{ cvss.baseSeverity }}</span>
                </td>
                <td data-label="Version" style="width: 20%">{{ cvss.version }}</td>
                <td data-label="Vector String">{{ cvss.vectorString }}</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</template>
  
<script>
import { useCveRecordLookupStore } from '@/stores/cveRecordLookup.ts';

export default {
  props: {
    containerObject: {
      type: Object,
      required: true,
    },
    role: {
      type: String,
      required: true,
    },
  },
  data() {
    return {
      cwes: [],
      cvsss: [],
      kevs: [],
      ssvcs: [],
      roleName: this.role,
      dateUpdated: '',
      cveServicesBaseUrl: import.meta.env.VITE_CVE_SERVICES_BASE_URL,
      useCveRecordLookupStore: useCveRecordLookupStore(),
    }
  },
  methods: {
    hasEnrichmentData(){
      if (this.cwes.length > 0 || this.cvsss.length > 0 || this.kevs.length > 0 || this.ssvcs.length > 0) {
        return true;
      }
      return false;
    },
    getCvsss(metricObj) {
      Object.keys(metricObj).forEach( (metricObjKey) =>{
        const cvssVersion = metricObjKey;
        const supportedCvssVersions = ['cvssV4_0', 'cvssV3_1', 'cvssV3_0', 'cvssV2_0'];

        let cvss = {
          baseScore: '—',
          baseSeverity: '—',
          baseSeverityColorClass: 'is-white',
          version: '—',
          vectorString: '—'
        }

        if (supportedCvssVersions.includes(cvssVersion)) {
          if (metricObj[cvssVersion]?.baseScore || typeof metricObj[cvssVersion].baseScore === 'number') cvss.baseScore =  metricObj[cvssVersion].baseScore;

          if (metricObj[cvssVersion]?.baseSeverity) {
            if (metricObj[cvssVersion]?.baseSeverity) cvss.baseSeverity =  metricObj[cvssVersion].baseSeverity;
            if ( ['high', 'critical'].includes(metricObj[cvssVersion].baseSeverity.toLowerCase())) {
              cvss.baseSeverityColorClass = 'is-danger';
            } else if (metricObj[cvssVersion].baseSeverity.toLowerCase() === 'medium') {
              cvss.baseSeverityColorClass = 'is-warning';
            } else if (metricObj[cvssVersion].baseSeverity.toLowerCase() === 'low') {
              cvss.baseSeverityColorClass = 'is-info';
            } else {
              cvss.baseSeverityColorClass = 'is-white';
            }
          }

          if (metricObj[cvssVersion]?.version) cvss.version = metricObj[cvssVersion].version;
            if (metricObj[cvssVersion]?.vectorString) cvss.vectorString =  metricObj[cvssVersion]?.vectorString;
          
          this.cvsss.push(cvss);
        }
      });
    },
    getKevs(metricObj) {
      const isOtherKey = Object.keys(metricObj).toString().toLowerCase() === 'other' ? true : false;
      if (isOtherKey) {
        if (metricObj.other?.type && metricObj.other.type.toLowerCase() === 'kev' ) {
          this.kevs.push(metricObj.other.content);
        }
      }
    },
    getSsvcs(metricObj){
      const isOtherKey = Object.keys(metricObj).toString().toLowerCase() === 'other' ? true : false;
      const requiredOptionsAllowedValues = {
            "exploitation": ['none', 'public poc', 'poc', 'active'],
            "automatable": ['no', 'yes'],
            "technical impact": ['partial', 'total']
          }
      if (isOtherKey) {
        if (metricObj.other?.type && metricObj.other.type.toLowerCase() === 'ssvc' ) {
          let requiredOptions = {
            exploitation: '—',
            automatable: '—',
            'technical impact': '—'
          }

          let otherFields = {
            version: '—',
            timeStamp: '—'
          }

          if (metricObj.other.content?.options) {
            metricObj.other.content?.options.forEach( (option) =>{
              const originalOptionKey = Object.keys(option);
              const optionKey = Object.keys(option).toString().toLowerCase();
              if (optionKey === 'exploitation' && requiredOptionsAllowedValues.exploitation.includes(option[originalOptionKey].toLowerCase())) {
                requiredOptions.exploitation = option[originalOptionKey];
              }
              if (optionKey === 'automatable' && requiredOptionsAllowedValues.automatable.includes(option[originalOptionKey].toLowerCase())) {
                requiredOptions.automatable = option[originalOptionKey];
              }
              if (optionKey === 'technical impact' &&
                requiredOptionsAllowedValues['technical impact'].includes(option[originalOptionKey].toLowerCase())) {
                requiredOptions['technical impact'] = option[originalOptionKey];
              }
            });

            if (metricObj.other.content?.version) {
              otherFields.version = metricObj.other.content?.version.length > 1 ? metricObj.other.content.version : '-';
            }

            if (metricObj?.other?.content?.timestamp) {
              otherFields.timeStamp = this.getDate(metricObj.other.content.timestamp);
            }
          }


          this.ssvcs.push({
            exploitation: requiredOptions.exploitation,
            automatable: requiredOptions.automatable,
            'technical impact': requiredOptions['technical impact'],
            version: otherFields.version,
            timestamp: otherFields.timeStamp
          });
        }
      }
    },
    getCvsssCwes() {
      if (this.containerObject?.problemTypes) {
        this.containerObject.problemTypes.forEach( (problemType) => {
          if (problemType?.descriptions) {
            problemType.descriptions.forEach( (description) => {
              if (description?.type && description.type.toLowerCase() === 'cwe') {
                if (description?.cweId) {
                  const [,cweNumber] = description.cweId.split('-');
                  description.cweNumber = cweNumber;
                } else {
                  description.cweId = 'CWE ID not provided'
                  description.cweNumber = undefined
                }

                // description field is required so this should not ever happen
                if (!description?.description) {
                  description.description = '';
                }

                if (description.cweId !== 'CWE ID not provided' || description.description.length > 0) {
                  this.cwes.push(description);
                }
              }
            });
          }
        });
      }

      if (this.containerObject?.metrics) {
        this.containerObject.metrics.forEach( (metricObj) => {
          this.getCvsss(metricObj);
          this.getKevs(metricObj);
          this.getSsvcs(metricObj);
        });
      }
    },
    getUpdatedDate() {
      this.dateUpdated = this.getDate(this.containerObject.providerMetadata.dateUpdated);
    },
    getDate(dateTime) {
      const [date] = dateTime.split('T');
      return date;
    },
  },
  beforeMount() {
    this.getCvsssCwes();
    this.getUpdatedDate();
  }
};
</script>

<!-- Add "scoped" attribute to limit CSS to this component only -->
<style scoped lang="scss">
@import '../assets/style/globals.scss';

</style>
  