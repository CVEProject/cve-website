<template>
  <div>
    <h4 class="title is-size-5 mb-0">Product Status</h4>
    <router-link to="/CVERecord/UserGuide/#cve-product-status" class="cve-learn-more-link">Learn more</router-link>
    <div class="mt-4">
      <div v-if="useCveRecordLookupStore.emptyProductStatus[role]">
        <p class="is-italic cve-help-text">Information not provided</p>
      </div>
      <div v-else>
        <div v-for="(product, index) in productStatusList" :key="`${index}-${product.vendor}`">
          <div id="cve-vendor-product-platforms" class="column is-12-desktop mb-4 cve-row cve-light-gray-bg">
            <nav id="cve-vendor-product-platforms" class="level cve-x-scroll">
              <div class="level-item" v-if="product.vendor.length > 0">
                <div>
                  <p class="cve-product-status-heading">Vendor</p>
                  <p>{{ product.vendor }}</p>
                </div>
              </div>
              <div class="level-item" v-if="product.product.length > 0">
                <div>
                  <p class="cve-product-status-heading">Product</p>
                  <p>{{ product.product }}</p>
                </div>
              </div>
              <div class="level-item" v-if="product.platforms.length > 0">
                <div>
                  <p class="cve-product-status-heading">Platforms</p>
                  <p>{{ product.platforms.join(', ') }}</p>
                </div>
              </div>
            </nav>
            <div id="cve-affected-unaffected-unknown-versions">
              <p class="cve-product-status-heading pb-1" style="border-bottom: 1px solid lightgray;">
                Versions
                <span class="tag  is-normal">{{ productStatusList.length }} Total</span>
              </p>
             
              <div class="column is-12-desktop cve-versions-scroll mb-4" ref="version-ref">
                <div id="cve-version-default-status">
                  <p v-if="product.defaultStatus" class="cve-help-text is-italic">
                    <span class="has-text-weight-bold">Default Status: </span>{{product.defaultStatus}}
                  </p>
                  <p v-else class="cve-help-text is-italic"><span class="has-text-weight-bold">Default Status: </span>unknown</p>
                </div>
                <div v-for="header in product.versionsColumns.headers" :key="header.key">
                  <div :id="header" class="mt-1">
                    <p style="text-transform: capitalize;">{{ header }}</p>
                    <ul class="menu-list mt-1" v-for="row in product.versionsColumns.twoDTable[header]" :key="row.key">
                      <li>
                        <span v-if="row.versionsChanges.length > 0">
                          <p>
                            {{row.parentVersionStatus}}
                            <span v-for="word in row.parentVersionRange" :key="word.key" :class="isAversion(word) ? 'cve-version' : ''">{{word}}&nbsp;</span>
                          </p>
                          <ul style="border-left: none !important;">
                            <li v-for="change in row.versionsChanges" :key="change.key">
                              <span v-for="word in change" :key="word.key" :class="isAversion(word) ? 'cve-version' : ''">{{word}}&nbsp;</span>
                            </li>
                          </ul>
                        </span>
                        <span v-else>
                          <span v-if="row.parentVersionRange.length > 0">{{row.parentVersionStatus}}
                            <span v-for="word in row.parentVersionRange" :key="word.key" :class="isAversion(word) ? 'cve-version' : ''">{{word}}&nbsp;</span>
                          </span>
                          <span v-else>
                            {{row.parentVersionStatus}} {{row.parentVersionRange}}
                          </span>
                        </span>
                      </li>
                    </ul>
                  </div>
                </div>
              </div>
            </div>
            <!-- <div id="cve-cpes" v-if="product.cpes.length > 0">
              <p class="cve-product-status-heading" style="border-bottom: 1px solid lightgray;">CPEs</p>
              <div class="cve-xy-scroll">
                <ul>
                  <li v-for="cpe in product.cpes" :key="cpe.key">{{ cpe.concat('dsfsdfasfasfasfasf:8:8:8:8:*:8:8*::*:*:*:*') }}</li>
                </ul>
              </div>
            </div> -->
          </div>
        </div>
      </div>
    </div>
  </div>
</template>
  
<script>
import { useCveRecordLookupStore } from '@/stores/cveRecordLookup.ts';

export default {
  props: {
    productStatusList: {
      type: Object,
      required: true,
    },
    role: {
      type: String,
      required: true,
    },
  },
  data() {
    return {
      useCveRecordLookupStore: useCveRecordLookupStore()
    }
  },
  methods: {
    isAversion(version) {
      const notAversion = ['affected', 'unaffected', 'unknown', 'from', 'before', 'through', 'at'];

      if (notAversion.indexOf(version) > -1) return false;
      return true;
    },
    isVendorProductVersionDefaultStatusNa() {
      if (this.productStatusList.length === 1) {
        const isVendorNa = /n\/a/.test(this.productStatusList[0].vendor.toLowerCase());
        const isProductNa = /n\/a/.test(this.productStatusList[0].product.toLowerCase());
        const isDefaultStausNa = this.productStatusList[0].defaultStatus.length === 0;
        let isVersionNa = false;

        if (this.productStatusList[0].versionsColumns.twoDTable.affected.length === 1) {
          isVersionNa = /n\/a/.test(this.productStatusList[0].versionsColumns.twoDTable.affected[0].parentVersionRange.toString().toLowerCase());
        }

        if (isVendorNa && isProductNa && isVersionNa && isDefaultStausNa) {
          useCveRecordLookupStore().emptyProductStatus[this.role] = true;
        } else {
          useCveRecordLookupStore().emptyProductStatus[this.role] = false;
        }
      }
    }
  },
  mounted() {
    this.isVendorProductVersionDefaultStatusNa();
  }
};
</script>
  
<style lang="scss">
  @import '@/assets/style/globals.scss'; 
</style>

<!-- Add "scoped" attribute to limit CSS to this component only -->
<style scoped lang="scss">

.cve-version {
  color: $theme-color-violet-vivid-60;
  font-weight: 700;
}

.cve-light-gray-bg {
  background-color: #FFF;
  border-radius: $cve-border-radius;
  border: $white-ter solid 1px;
}

.cve-product-status-heading{
  font-weight: 700;
  margin-bottom: 0.25rem !important;
}

.level {
  gap: 1rem;
}
.level-item {
  justify-content: left!important;
}

.cve-versions-scroll {
  max-height: 235px;
  border-bottom: 1px solid lightgray;
  overflow-y: scroll;
}
 </style>
  