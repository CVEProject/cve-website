<template>
  <div id="cve-cvsss-cwes" class="mb-5">
    <p class="cve-help-text">
        SSCV, KEV, CVSS, and CWE data are shown below, if provided by the ADP. To view all fields and data for this record from both containers,
        select the
        <a id="cve-view-json" :href="`https://${cveServicesBaseUrl}/api/cve/${useCveRecordLookupStore.cveId}`" target="_blank">View JSON</a> link.
      </p>
    <div>
      <slot></slot>
      <p v-if="role === 'adp' && dateUpdated.length > 0">
        <span class="has-text-weight-semibold">Updated: </span>
        <time>{{dateUpdated}}</time>
      </p>
      <div id="cve-ssvcs" v-if="ssvcs.length > 0 && role === 'adp'" class="mt-5">
        <h4 class="title">SSVC</h4>
        <div class="cve-y-scroll">
          <div class="table-container cve-y-scroll" id="downloads-table">
            <table class="table is-striped is-hoverable cve-border-dark-blue cve-border-bottom-unset mt-0">
              <thead>
                <tr>
                  <th style="width: 20%">Exploitation</th>
                  <th style="width: 20%">Automable</th>
                  <th style="width: 10%">Technical Impact</th>
                  <th style="width: 10%">Version</th>
                  <th style="width: 20%">Date Accessed</th>
                </tr>
              </thead>
              <tbody>
                <tr v-for="ssvc in ssvcs" :key="ssvc.key">
                  <td data-label="Exploitation" style="width: 20%">{{ ssvc.exploitation }}</td>
                  <td data-label="Automable" style="width: 10%">{{ ssvc.automatable }}</td>
                  <td data-label="Technical Impact" style="width: 30%">{{ ssvc['technical impact'] }}</td>
                  <td data-label="Version" style="width: 10%">{{ ssvc.version }}</td>
                  <td data-label="Date Accessed" style="width: 30%">{{ ssvc.timestamp }}</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
      <div id="cve-kevs" v-if="kevs.length > 0 && role === 'adp'" class="mt-5">
        <h4 class="title">KEV</h4>
        <div class="cve-y-scroll">
          <ul class="mt-0">
            <li v-for="kev in kevs" :key="kev.key">
              <a :href="kev.reference" target="_blank">{{ kev.reference }}</a><span class="is-italic cve-help-text"> ({{ kev.dateAdded }})</span>
            </li>
          </ul>
        </div>
      </div>
      <div id="cve-cwes" v-if="cwes.length > 0" class="mt-5">
        <h4 class="title">CWE</h4>
        <div class="cve-y-scroll">
          <ul class="mt-0">
            <li v-for="cwe in cwes" :key="cwe.key">
              <span class="has-text-weight-bold">{{ cwe.cweId }}: </span><span>{{ cwe.description }}</span>
            </li>
          </ul>
        </div>
      </div>
      <div id="cve-cvsss" v-if="cvsss.length > 0" class="mt-5 mb-5">
        <h4 class="title">CVSS</h4>
        <div class="table-container cve-y-scroll" id="downloads-table">
          <table class="table is-striped is-hoverable cve-border-dark-blue cve-border-bottom-unset mt-0">
            <thead>
              <tr>
                <th style="width: 20%">Score</th>
                <th style="width: 20%">Severity</th>
                <th style="width: 20%">Version</th>
                <th>Vector String</th>
              </tr>
            </thead>
            <tbody>
              <tr v-for="cvss in cvsss" :key="cvss.key">
                <td data-label="Score" style="width: 20%">{{ cvss.baseScore }}</td>
                <td data-label="Severity" style="width: 20%">
                  <span :class="cvss.baseSeverityColorClass" class="tag is-info has-text-weight-bold cve-state-tag">{{ cvss.baseSeverity }}</span>
                </td>
                <td data-label="Version" style="width: 20%">{{ cvss.version }}</td>
                <td data-label="Vector String">{{ cvss.vectorString }}</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</template>
  
<script>
import { useCveRecordLookupStore } from '@/stores/cveRecordLookup.ts';

export default {
  props: {
    containerObject: {
      type: Object,
      required: true,
    },
    role: {
      type: String,
      required: true,
    },
  },
  data() {
    return {
      cwes: [],
      cvsss: [],
      kevs: [],
      ssvcs: [],
      role: this.role,
      dateUpdated: '',
      cveServicesBaseUrl: import.meta.env.VITE_CVE_SERVICES_BASE_URL,
      useCveRecordLookupStore: useCveRecordLookupStore(),
    }
  },
  methods: {
    hasEnrichmentData(){
      if (this.cwes.length > 0 || this.cvsss.length > 0 || this.kevs.length > 0 || this.ssvcs.length > 0) {
        return true;
      }
      return false;
    },
    getCvsss(metricObj) {
      const cvssVersion = Object.keys(metricObj).toString();
      if (['cvssV4_0', 'cvssV3_1', 'cvssV3_0', 'cvssV2_0'].includes(cvssVersion)) {
        if (metricObj[cvssVersion].baseSeverity.toLowerCase() === 'high') {
          metricObj[cvssVersion].baseSeverityColorClass = 'is-warning'
        } else if (metricObj[cvssVersion].baseSeverity.toLowerCase() === 'medium') {
          metricObj[cvssVersion].baseSeverityColorClass = 'is-warning'
        } else {
          metricObj[cvssVersion].baseSeverityColorClass = 'is-info'
        }
        this.cvsss.push(metricObj[cvssVersion]);
      }
    },
    getKevs(metricObj) {
      const isOtherKey = Object.keys(metricObj).toString().toLowerCase() === 'other' ? true : false;
      if (isOtherKey) {
        if (metricObj.other?.type && metricObj.other.type.toLowerCase() === 'kev' ) {
          this.kevs.push(metricObj.other.content);
        }
      }
    },
    getSsvcs(metricObj){
      const isOtherKey = Object.keys(metricObj).toString().toLowerCase() === 'other' ? true : false;
      if (isOtherKey) {
        if (metricObj.other?.type && metricObj.other.type.toLowerCase() === 'ssvc' ) {
          let requiredOptions = {
            "exploitation": "",
            "automatable": "",
            "technical impact": ""
          }
          if (metricObj.other.content?.options) {
            metricObj.other.content?.options.forEach( (option) =>{
              const originalOptionKey = Object.keys(option);
              const optionKey = Object.keys(option).toString().toLowerCase();
              if (optionKey === 'exploitation') requiredOptions.exploitation = option[originalOptionKey];
              if (optionKey === 'automatable') requiredOptions.automatable = option[originalOptionKey];
              if (optionKey === 'technical impact') requiredOptions['technical impact'] = option[originalOptionKey];
            });
          }
          this.ssvcs.push({
            exploitation: requiredOptions.exploitation,
            automatable: requiredOptions.automatable,
            'technical impact': requiredOptions['technical impact'],
            version: metricObj.other.content.version,
            timestamp: this.getDate(metricObj.other.content.timestamp)
          });
        }
      }
    },
    getCvsssCwes() {
      if (this.containerObject?.problemTypes) {
        this.containerObject.problemTypes.forEach( (problemType) => {
          if (problemType?.descriptions) {
            problemType.descriptions.forEach( (description) => {
              if (description.type.toLowerCase() === 'cwe') {
                this.cwes.push(description);
              }
            });
          }
        });
      }

      if (this.containerObject?.metrics) {
        this.containerObject.metrics.forEach( (metricObj) => {
          this.getCvsss(metricObj);
          this.getKevs(metricObj);
          this.getSsvcs(metricObj);
        });
      }
    },
    doesCvsssCWesExist() {
      if (this.cwes.length > 0 || this.cvsss.length > 0) useCveRecordLookupStore().hasAdpInfo = true;
    },
    getUpdatedDate() {
      this.dateUpdated = this.getDate(this.containerObject.providerMetadata.dateUpdated);
    },
    getDate(dateTime) {
      const [date] = dateTime.split('T');
      return date;
    },
  },
  beforeMount() {
    this.getCvsssCwes();
    this.getUpdatedDate();
  }
};
</script>

<!-- Add "scoped" attribute to limit CSS to this component only -->
<style scoped lang="scss">
@import '../assets/style/globals.scss';

.level {
  gap: 1rem;
}
.level-item {
  justify-content: left!important;
}
  </style>
  