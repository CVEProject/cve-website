<template>
  <div id="cve-cvsss-cwes" class="mb-5">
    <slot></slot>
    <p v-if="role === 'adp' && dateUpdated.length > 0">
      <span class="has-text-weight-semibold">Updated: </span>
      <time>{{dateUpdated}}</time>
    </p>
    <div id="cve-cvsss" v-if="cvsss.length > 0" class="mt-5 mb-5">
      <h4 class="title">CVSS</h4>
      <div class="table-container cve-y-scroll" id="downloads-table">
        <table class="table is-striped is-hoverable cve-border-dark-blue cve-border-bottom-unset mt-0">
          <thead>
            <tr>
              <th>Version</th>
              <th>Score</th>
              <th>Severity</th>
              <th>Vector String</th>
            </tr>
          </thead>
          <tbody>
            <tr v-for="cvss in cvsss" :key="cvss.key">
              <td data-label="Version">{{ cvss.version }}</td>
              <td data-label="Score">{{ cvss.baseScore }}</td>
              <td data-label="Severity">{{ cvss.baseSeverity }}</td>
              <td data-label="Vector String">{{ cvss.vectorString }}</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
    <div id="cve-cwes" v-if="cwes.length > 0">
      <h4 class="title">CWE</h4>
      <div class="cve-y-scroll">
        <ul class="mt-0">
          <li v-for="cwe in cwes" :key="cwe.key">
            <span class="has-text-weight-bold">{{ cwe.cweId }}: </span><span>{{ cwe.description }}</span>
          </li>
        </ul>
      </div>
    </div>
  </div>
</template>
  
  <script>
  export default {
    props: {
      containerObject: {
        type: Object,
        required: true,
      },
      role: {
        type: String,
        required: true,
      },
    },
    data() {
      return {
        cwes: [],
        cvsss: [],
        role: this.role,
        dateUpdated: '',
      }
    },
    methods: {
      getCvsssCwes() {
        if (this.containerObject?.problemTypes) {
          this.containerObject.problemTypes.forEach( (problemType) => {
            if (problemType?.descriptions) {
              problemType.descriptions.forEach( (description) => {
                if (description.type.toLowerCase() === 'cwe') {
                  this.cwes.push(description);
                }
              });
            }
          });
        }

        if (this.containerObject?.metrics) {
          this.containerObject.metrics.forEach( (metric) => {
            let metricsProperties = Object.keys(metric).toString();
            const matchArr = metricsProperties.match(new RegExp(/cvssV2_0|cvssV3_0|cvssV3_1|cvssV4_0/, 'i'));
            const cvssVersion = matchArr !== null ? matchArr[0] : undefined;
            if (typeof cvssVersion !== 'undefined') {
              this.cvsss.push(metric[cvssVersion]);
            }
          });
        }
      },
      doesCvsssCWesExist() {
        if (this.cwes.length > 0 || this.cvsss.length > 0) useCveRecordLookupStore().hasAdpInfo = true;
      },
      getUpdatedDate() {
        this.dateUpdated = this.getDate(this.containerObject.providerMetadata.dateUpdated);
      },
      getDate(dateTime) {
        const [date] = dateTime.split('T');
        return date;
      },
    },
    beforeMount() {
      this.getCvsssCwes();
      this.getUpdatedDate();
    }
  };
  </script>
  
  <!-- Add "scoped" attribute to limit CSS to this component only -->
  <style scoped lang="scss">
  @import '../assets/style/globals.scss';
  
.level {
  gap: 1rem;
}
.level-item {
  justify-content: left!important;
}
  </style>
  