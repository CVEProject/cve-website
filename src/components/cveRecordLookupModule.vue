<template>
  <div class="field mt-1" style="">
    <div class="field has-addons mb-1">
      <div class="control is-expanded">
        <input v-model="queryString" @keyup.enter="onKeyUpEnter" @keyup="validateQueryString" type="text" class="input cve-id-input"
          placeholder="Enter keywords (e.g.: CVE ID, sql injection, etc.)"/>
      </div>
      <div class="control">
        <button @click="startSearch"
          class="button cve-button cve-button-accent-warm"
          :class="{'is-loading': cveListSearchStore.isSearching, 'disabled': cveListSearchStore.isSeachButtonDisabled}"
          :aria-disabled="cveListSearchStore.isSeachButtonDisabled">
          Find {{ websiteEnv === 'test' ? 'a Test CVE Record/ID' : ''}}
        </button>
      </div>
    </div>
    <div class="notification is-warning is-light" role="alert" v-if="errorMessage.length > 0">
      <div class="is-flex" style="justify-content: flex-start;">
        <p id="alertIcon" class="is-hidden">alert</p>
        <font-awesome-icon style="flex: 0 0 40px; margin-top:3px" size="lg"  icon="exclamation-triangle" role="alert"
          aria-labelledby="alertIcon" aria-hidden="false" />
          <p class="cve-help-text">
            {{errorMessage}}
            <router-link to="/About/Process#request"> Learn more</router-link>
          </p>
      </div>
    </div>

  </div>
</template>

<script setup>
import { useCveListSearchStore } from '@/stores/cveListSearch';
import { computed, ref, watch } from 'vue';
import { useRoute, useRouter } from 'vue-router';
let cveListSearchStore = useCveListSearchStore();
const route = useRoute();
const router = useRouter()

let queryString = ref('');
let errorMessage = ref('');


watch(
  () => route.query,
  () => {
    console.log(`>> watch route.query: ${route.query?.query}; store.query: ${cveListSearchStore.query}`);
    if (route.query?.query){
      queryString.value = route.query.query;
      validateQueryString();
      if (!cveListSearchStore.showHelpText) {
        console.log(`watch route.query: ${route.query?.query}; store.query: ${cveListSearchStore.query}; queryString: ${queryString.value}`);
        startSearch();
      }
    } else {
      queryString.value = cveListSearchStore.query = '';
    }
  }
)


function startSearch() {
  console.log(`>> startSearch() >> isSearching: ${cveListSearchStore.isSearching}, route.name: ${route.name}, route.query.query: ${route.query.query}, queryString.value: ${queryString.value}, cveListSearchStore.query: ${cveListSearchStore.query}`)
  console.log(route)
  
  // TODO Sanitize
  if (queryString.value !== cveListSearchStore.query) {
    cveListSearchStore.$reset();
    console.log(`startSearch() queryString.value !== cveListSearchStore.query >> ${route.name}, ${route.query.query}, ${queryString.value}, ${cveListSearchStore.query}`);
    cveListSearchStore.query = queryString.value;
    const currentPath = route.fullPath;
    const newPath = `/CVERecord/SearchResults?query=${cveListSearchStore.query}`;
      console.log(`startSearch() >> currentPath !== newPath`)
      console.log(`startSearch >> pushing new path`)
      router.push({
        name: 'SearchResults',
        query: {query: cveListSearchStore.query}
      });
      cveListSearchStore.search();
  }
}

function validateQueryString() {
  console.log(`>> validateQueryString() >> ${queryString.value}`)
  const alphaNumericDashPattern = new RegExp(/^[a-zA-Z0-9- ]+$/, 'i').test(queryString.value);
  if (queryString.value.length > 0 && !alphaNumericDashPattern) {
    cveListSearchStore.isSeachButtonDisabled = true;
    errorMessage.value = 'Only letters, numbers, and hyphens are allowed.';
    cveListSearchStore.showHelpText = true;
  } else if (queryString.value.length === 0) {
    cveListSearchStore.isSeachButtonDisabled = true;
    errorMessage.value = '';
    cveListSearchStore.showHelpText = false;
  } else {
    cveListSearchStore.isSeachButtonDisabled = false;
    errorMessage.value = '';
    cveListSearchStore.showHelpText = false;
  }
}

function onKeyUpEnter() {
  if (!cveListSearchStore.isSeachButtonDisabled) {
    console.log('>> onKeyUpEnter()');
    startSearch();
  }
}

const websiteEnv = computed(() => {
  return import.meta.env.VITE_WEBSITE_ENVIRONMENT;
});
</script>

<style scoped lang="scss">
.disabled {
  opacity: 0.7 !important;
  background-color: #3d4551;
  color: white;
  border-color: #dbdbdb;
  box-shadow: none;
}

.notification {
  margin: 0 0 2px 0 !important;
  padding: 2px 10px 2px 10px  !important;
}

@media screen and (min-width: $desktop) {
  .cve-id-input {
    width: 400px;
  }
}
</style>