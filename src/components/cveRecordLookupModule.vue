<template>
  <div class="field mt-1" style="">
    <div class="field has-addons mb-1">
      <div class="control is-expanded">
        <input v-model="query" @keyup.enter="onKeyUpEnter" @keyup="validateQueryString" @blur="removeHelpText" type="text" class="input cve-id-input"
          placeholder="Enter keywords (e.g.: CVE ID, sql injection, etc.)"/>
      </div>
      <div class="control">
        <button 
          class="button cve-button cve-button-accent-warm"
          :class="{'is-loading': useCveListSearchStore.cveRecordIsLoading || useCveListSearchStore.searchResultIsLoading, 'disabled': findDisabled}"
          :aria-disabled="findDisabled" @click="startSearch">
          Find {{ websiteEnv === 'test' ? 'a Test CVE Record/ID' : ''}}
        </button>
      </div>
    </div>
    <div class="notification is-warning is-light" role="alert" v-if="errorMessage.length > 0">
      <div class="is-flex" style="justify-content: flex-start;">
        <p id="alertIcon" class="is-hidden">alert</p>
        <font-awesome-icon style="flex: 0 0 40px; margin-top:3px" size="lg"  icon="exclamation-triangle" role="alert"
          aria-labelledby="alertIcon" aria-hidden="false" />
          <p class="cve-help-text">
          <ul v-for="errorMsg in errorMessage" :key="errorMsg.key" class="pl-4" style="list-style: square">
            <li class="cve-help-text" v-html="errorMsg"></li>
          </ul>
        <router-link to="/About/Process#request"> Learn more</router-link>
        </p>
      </div>
    </div>
  </div>
</template>

<script>
import { useCveListSearchStore } from '@/stores/cveListSearch';

export default {
  data() {
    return {
      query: useCveListSearchStore().query,
      errorMessage: [],
      findDisabled: true,
      getIdStatusCode: undefined,
      useCveListSearchStore: useCveListSearchStore(),
    };
  },
  created() {
    const isQueryInUrl = this.$route.name === 'SearchResults' && this.$route.query?.query ? true : false;
    if (isQueryInUrl) {
      const query = this.$route.query.query;
      // TODO SANITIZE INPUT
      useCveListSearchStore().query = query;
      this.query = this.$route.query.query;
      this.validateQueryString();
      if (!this.findDisabled) {
        console.log('startSearch - created');
        this.startSearch();
      } else {
        useCveListSearchStore().showHelpText = true;
      }
    }
  },
  watch: {
    $route(to) {
      console.log('useCveListSearchStore.isSearching: ', useCveListSearchStore().isSearching)
      if (useCveListSearchStore().isSearching) {
        return;
      }
      if (to.query?.query) {
        // todo sanitize
        useCveListSearchStore().query = to.query.query;
        this.query = to.query.query;
        this.validateQueryString();
        if (!this.findDisabled) {
          console.log('startSearch - $route');
          this.startSearch();
        } else {
          this.resetStates();
          useCveListSearchStore().showHelpText = true;
        }
      } else {
        // e.g., /SearchResults?query=&<valid-keywords>
        this.validateQueryString();
        useCveListSearchStore().showHelpText = true;
      }
    },
  },
  computed: {
    websiteEnv() {
      return import.meta.env.VITE_WEBSITE_ENVIRONMENT;
    }
  },
  methods: {
    startSearch() {
      this.resetStates();
      this.setLoadingState();
      // TODO Sanitize
      useCveListSearchStore().query = this.query;
      // * Check if keyword is CVE ID
      var isCveIdPattern = new RegExp(/^CVE-\d{4}-\d{4,7}$/, 'i').test(useCveListSearchStore().query);
      if (isCveIdPattern) {
        useCveListSearchStore().totalExecutingRequests = 2;
      } else {
        useCveListSearchStore().totalExecutingRequests = 1;
      }

      if (this.$route.name !== 'SearchResults' || this.$route.query.query !== this.query) {
        const currentPath = this.$route.fullPath;
        const newPath = `/CVERecord/SearchResults?query=${useCveListSearchStore().query}`;
        if (currentPath !== newPath) {
          this.$router.push(newPath);
        }
      }

      this.search(isCveIdPattern);
    },
    search(isCveIdPattern) {
      // 1st, lookup ID to get Record data, and continue to get CVE Records that mention that ID
      if (isCveIdPattern) {
        useCveListSearchStore().cveId = useCveListSearchStore().query.toUpperCase();

        this.getRecordData();
      }
      // * 2nd, query search service
      useCveListSearchStore().getSearchResults();
    },
    removeHelpText() {
      if (this.query.length === 0) {
        this.errorMessage = [];
      }
    },
    validateQueryString() {
      this.errorMessage = [];
      const alphaNumericDashPattern = new RegExp(/^[a-zA-Z0-9- ]+$/, 'i').test(this.query);
      if (this.query.length > 0 && !alphaNumericDashPattern) {
        this.findDisabled = true;
        this.errorMessage.push('Only letters, numbers, and hyphens are allowed');
        useCveListSearchStore.showHelpText = true;
      } else {
        this.findDisabled = false;
      }
    },
    resetStates() {
      useCveListSearchStore().$reset();
      console.log('resetStates');
      console.log(useCveListSearchStore())
    },
    async getRecordData() {
      useCveListSearchStore().cveRecordIsLoading = true;
      const getRecordUrl = `/api/cve/${useCveListSearchStore().cveId}`;
      console.log(getRecordUrl);

      try {
        axios.defaults.baseURL = `https://${import.meta.env.VITE_CVE_SERVICES_BASE_URL}`;
        const response = await axios.get(getRecordUrl);
        const cveRecordData = response?.data || {};
        console.log('const cveRecordData = response?.data || {}; ', response?.data || {})
        console.log('Got record data');
        console.log(response)
        useCveListSearchStore().isArecord = true;
        useCveListSearchStore().isIdOrRecordFound = false;

        // format description
        let descriptions = [];
        cveRecordData.containers?.cna?.descriptions.forEach((description) => {
          if (description.lang === "en") descriptions.push(description.value);
        });
        let recordDataSummary = {
          cveId: cveRecordData?.cveMetadata?.cveId || 'No ID provided',
          cna: cveRecordData?.cveMetadata?assignerShortName || 'No CNA provided'.
          descriptions: descriptions,
          relevancyScore: 'not appliciable'
        }
        useCveListSearchStore().recordData = recordDataSummary;
        console.log('useCveListSearchStore().recordData = recordDataSummary; ', recordDataSummary)

        if (cveRecordData?.cveMetadata.state === 'PUBLISHED') {
          useCveListSearchStore().isPublished = true;
        } else if (cveRecordData?.cveMetadata.state === 'REJECTED') {
          useCveListSearchStore().isRejected = true;
        }
      } catch (e) {
        console.log(`Error: couldn't get record data`);
        console.log(e)
        useCveListSearchStore().isRecordServerError = true;

        useCveListSearchStore().isPublished = false;
        useCveListSearchStore().isReserved = false;
        useCveListSearchStore().isRejected = false;
        useCveListSearchStore().isIdOrRecordFound = false;
        useCveListSearchStore().isArecord = false;
      } finally {
        useCveListSearchStore().cveRecordIsLoading = false;
        useCveListSearchStore().decrement('totalExecutingRequests');
      }
    },
    handleServerError() {
      useCveListSearchStore().serverError = true;
      this.setLoadingState(false);
      useCveListSearchStore().isArecord = undefined;
    },
    handleIsIdOrRecordFound(newState) {
      useCveListSearchStore().serverError = false;
      useCveListSearchStore().isIdOrRecordFound = newState;
      this.setLoadingState(false);
    },
    setLoadingState() {
      useCveListSearchStore().showHelpText = false;
      useCveListSearchStore().isSearching = true;
      this.findDisabled = true;
    },
    onKeyUpEnter() {
      this.validateQueryString();

      if (!this.findDisabled) {
        console.log('startSearch - onKeyUpEnter');
        this.startSearch();
      }
    },
    isJson(value) {
      if (typeof value === 'object') {
        return true;
      }
      return false;
    },
  },
}

</script>

<style scoped lang="scss">
.disabled {
  opacity: 0.7 !important;
  background-color: #3d4551;
  color: white;
  border-color: #dbdbdb;
  box-shadow: none;
}

.notification {
  margin: 0 0 2px 0 !important;
  padding: 2px 10px 2px 10px  !important;
}

@media screen and (min-width: $desktop) {
  .cve-id-input {
    width: 400px;
  }
}
</style>